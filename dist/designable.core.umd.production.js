!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Designable=e.Designable||{},e.Designable.Core={}))}(this,(function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var t=function(e,o){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])},t(e,o)};function o(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}var n=function(){return n=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function i(e,t){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var n,i,r=o.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=r.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}return s}function r(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}var s,a=function(){function e(e){this.data=e||{clientX:0,clientY:0,pageX:0,pageY:0,target:null,view:Designable.Shared.globalThisPolyfill},this.transformCoordinates()}return e.prototype.transformCoordinates=function(){var e,t=((null===(e=this.data)||void 0===e?void 0:e.view)||{}).frameElement;if(t&&this.data.view!==Designable.Shared.globalThisPolyfill){var o=t.getBoundingClientRect(),n=o.width/t.offsetWidth;this.data.topClientX=this.data.clientX*n+o.x,this.data.topClientY=this.data.clientY*n+o.y,this.data.topPageX=this.data.pageX+o.x-this.data.view.scrollX,this.data.topPageY=this.data.pageY+o.y-this.data.view.scrollY;var i=document.elementFromPoint(this.data.topPageX,this.data.topClientY);i!==t&&(this.data.target=i)}else this.data.topClientX=this.data.clientX,this.data.topClientY=this.data.clientY,this.data.topPageX=this.data.pageX,this.data.topPageY=this.data.pageY},e}(),l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="drag:move",t}return o(t,e),t}(a),c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="drag:start",t}return o(t,e),t}(a),u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="drag:stop",t}return o(t,e),t}(a),d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="mouse:click",t}return o(t,e),t}(a),h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="mouse:dblclick",t}return o(t,e),t}(a),p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="mouse:move",t}return o(t,e),t}(a),v=function(){function e(e){this.data=Designable.Shared.getKeyCodeFromEvent(e),this.originEvent=e}return Object.defineProperty(e.prototype,"eventType",{get:function(){return this.originEvent.type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ctrlKey",{get:function(){return this.originEvent.ctrlKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shiftKey",{get:function(){return this.originEvent.shiftKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"metaKey",{get:function(){return this.originEvent.metaKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"altkey",{get:function(){return this.originEvent.altKey},enumerable:!1,configurable:!0}),e.prototype.preventDefault=function(){this.originEvent.preventDefault?this.originEvent.preventDefault():this.originEvent.returnValue=!1},e.prototype.stopPropagation=function(){var e;(null===(e=this.originEvent)||void 0===e?void 0:e.stopPropagation)?this.originEvent.stopPropagation():this.originEvent.cancelBubble=!0},e}(),f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="key:down",t}return o(t,e),t}(v),g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="key:up",t}return o(t,e),t}(v),y=function(e){this.data=e},b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="drag:node",t}return o(t,e),t}(y),m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="drop:node",t}return o(t,e),t}(y),w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="hover:node",t}return o(t,e),t}(y),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="insert:after",t}return o(t,e),t}(y),D=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="insert:before",t}return o(t,e),t}(y),E=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="insert:children",t}return o(t,e),t}(y),N=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="prepend:node",t}return o(t,e),t}(y),R=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="remove:node",t}return o(t,e),t}(y),C=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="select:node",t}return o(t,e),t}(y),P=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="unselect:node",t}return o(t,e),t}(y),k=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="update:children",t}return o(t,e),t}(y),A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="update:node:props",t}return o(t,e),t}(y),T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="wrap:node",t}return o(t,e),t}(y),O=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="clone:node",t}return o(t,e),t}(y),I=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="append:node",t}return o(t,e),t}(y),F=function(e){this.type="from:node",this.data=e},x=function(e){this.data=e||{scrollX:Designable.Shared.globalThisPolyfill.scrollX,scrollY:Designable.Shared.globalThisPolyfill.scrollY,width:Designable.Shared.globalThisPolyfill.innerWidth,height:Designable.Shared.globalThisPolyfill.innerHeight,innerWidth:Designable.Shared.globalThisPolyfill.innerWidth,innerHeight:Designable.Shared.globalThisPolyfill.innerHeight,view:Designable.Shared.globalThisPolyfill,target:Designable.Shared.globalThisPolyfill}},M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="viewport:resize",t}return o(t,e),t}(x),W=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="viewport:scroll",t}return o(t,e),t}(x),B=function(e){this.data=e},L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="add:workspace",t}return o(t,e),t}(B),X=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="remove:workspace",t}return o(t,e),t}(B),Y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="switch:workspace",t}return o(t,e),t}(B),z=function(e){this.data=e},q=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="history:undo",t}return o(t,e),t}(z),V=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="history:redo",t}return o(t,e),t}(z),U=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="history:goto",t}return o(t,e),t}(z),_=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="history:push",t}return o(t,e),t}(z),j={dragging:!1,onMouseDownAt:0,startEvent:null,moveEvent:null},K=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.mouseDownTimer=null,t.onMouseDown=function(e){var o,n;if(0===e.button&&!e.ctrlKey&&!e.metaKey)return!(!e.target.isContentEditable&&"true"!==e.target.contentEditable)||void((null===(n=null===(o=e.target)||void 0===o?void 0:o.closest)||void 0===n?void 0:n.call(o,".monaco-editor"))||(j.startEvent=e,j.dragging=!1,j.onMouseDownAt=Date.now(),t.batchAddEventListener("mouseup",t.onMouseUp),t.batchAddEventListener("dragend",t.onMouseUp),t.batchAddEventListener("dragstart",t.onStartDrag),t.batchAddEventListener("mousemove",t.onDistanceChange)))},t.onMouseUp=function(e){j.dragging&&t.dispatch(new u({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,target:e.target,view:e.view})),t.batchRemoveEventListener("contextmenu",t.onContextMenuWhileDragging,!0),t.batchRemoveEventListener("mouseup",t.onMouseUp),t.batchRemoveEventListener("mousedown",t.onMouseDown),t.batchRemoveEventListener("dragover",t.onMouseMove),t.batchRemoveEventListener("mousemove",t.onMouseMove),t.batchRemoveEventListener("mousemove",t.onDistanceChange),j.dragging=!1},t.onMouseMove=function(e){var o,n;e.clientX===(null===(o=j.moveEvent)||void 0===o?void 0:o.clientX)&&e.clientY===(null===(n=j.moveEvent)||void 0===n?void 0:n.clientY)||(t.dispatch(new l({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,target:e.target,view:e.view})),j.moveEvent=e)},t.onContextMenuWhileDragging=function(e){e.preventDefault()},t.onStartDrag=function(e){j.dragging||(j.startEvent=j.startEvent||e,t.batchAddEventListener("dragover",t.onMouseMove),t.batchAddEventListener("mousemove",t.onMouseMove),t.batchAddEventListener("contextmenu",t.onContextMenuWhileDragging,!0),t.dispatch(new c({clientX:j.startEvent.clientX,clientY:j.startEvent.clientY,pageX:j.startEvent.pageX,pageY:j.startEvent.pageY,target:j.startEvent.target,view:j.startEvent.view})),j.dragging=!0)},t.onDistanceChange=function(e){var o=Math.sqrt(Math.pow(e.pageX-j.startEvent.pageX,2)+Math.pow(e.pageY-j.startEvent.pageY,2));Date.now()-j.onMouseDownAt>10&&e!==j.startEvent&&o>4&&(t.batchRemoveEventListener("mousemove",t.onDistanceChange),t.onStartDrag(e))},t}return o(t,e),t.prototype.attach=function(){this.batchAddEventListener("mousedown",this.onMouseDown,!0)},t.prototype.detach=function(){j.dragging=!1,j.moveEvent=null,j.onMouseDownAt=null,j.startEvent=null,this.batchRemoveEventListener("mousedown",this.onMouseDown,!0),this.batchRemoveEventListener("dragstart",this.onStartDrag),this.batchRemoveEventListener("dragend",this.onMouseUp),this.batchRemoveEventListener("dragover",this.onMouseMove),this.batchRemoveEventListener("mouseup",this.onMouseUp),this.batchRemoveEventListener("mousemove",this.onMouseMove),this.batchRemoveEventListener("mousemove",this.onDistanceChange),this.batchRemoveEventListener("contextmenu",this.onContextMenuWhileDragging,!0)},t}(Designable.Shared.EventDriver),H=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onMouseClick=function(e){var o=e.target;(null==o?void 0:o.closest("*["+t.engine.props.clickStopPropagationAttrName+"]"))||t.dispatch(new d({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,target:e.target,view:e.view}))},t.onMouseDoubleClick=function(e){var o=e.target;(null==o?void 0:o.closest("*["+t.engine.props.clickStopPropagationAttrName+"]"))||t.dispatch(new h({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,target:e.target,view:e.view}))},t}return o(t,e),t.prototype.attach=function(){this.addEventListener("click",this.onMouseClick,{mode:"onlyChild"}),this.addEventListener("dblclick",this.onMouseDoubleClick,{mode:"onlyChild"})},t.prototype.detach=function(){this.removeEventListener("click",this.onMouseClick,{mode:"onlyChild"}),this.removeEventListener("dblclick",this.onMouseDoubleClick,{mode:"onlyChild"})},t}(Designable.Shared.EventDriver),G=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.request=null,t.onMouseMove=function(e){t.request=requestAnimationFrame((function(){cancelAnimationFrame(t.request),t.dispatch(new p({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,target:e.target,view:e.view}))}))},t}return o(t,e),t.prototype.attach=function(){this.addEventListener("mousemove",this.onMouseMove,{mode:"onlyOne"})},t.prototype.detach=function(){this.removeEventListener("mouseover",this.onMouseMove,{mode:"onlyOne"})},t}(Designable.Shared.EventDriver),$=[],Z="ResizeObserver loop completed with undelivered notifications.";!function(e){e.BORDER_BOX="border-box",e.CONTENT_BOX="content-box",e.DEVICE_PIXEL_CONTENT_BOX="device-pixel-content-box"}(s||(s={}));var J,Q=function(e){return Object.freeze(e)},ee=function(e,t){this.inlineSize=e,this.blockSize=t,Q(this)},te=function(){function e(e,t,o,n){return this.x=e,this.y=t,this.width=o,this.height=n,this.top=this.y,this.left=this.x,this.bottom=this.top+this.height,this.right=this.left+this.width,Q(this)}return e.prototype.toJSON=function(){var e=this;return{x:e.x,y:e.y,top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height}},e.fromRect=function(t){return new e(t.x,t.y,t.width,t.height)},e}(),oe=function(e){return e instanceof SVGElement&&"getBBox"in e},ne=function(e){if(oe(e)){var t=e.getBBox(),o=t.width,n=t.height;return!o&&!n}var i=e,r=i.offsetWidth,s=i.offsetHeight;return!(r||s||e.getClientRects().length)},ie=function(e){var t,o;if(e instanceof Element)return!0;var n=null===(o=null===(t=e)||void 0===t?void 0:t.ownerDocument)||void 0===o?void 0:o.defaultView;return!!(n&&e instanceof n.Element)},re="undefined"!=typeof window?window:{},se=new WeakMap,ae=/auto|scroll/,le=/^tb|vertical/,ce=/msie|trident/i.test(re.navigator&&re.navigator.userAgent),ue=function(e){return parseFloat(e||"0")},de=function(e,t,o){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===o&&(o=!1),new ee((o?t:e)||0,(o?e:t)||0)},he=Q({devicePixelContentBoxSize:de(),borderBoxSize:de(),contentBoxSize:de(),contentRect:new te(0,0,0,0)}),pe=function(e,t){if(void 0===t&&(t=!1),se.has(e)&&!t)return se.get(e);if(ne(e))return se.set(e,he),he;var o=getComputedStyle(e),n=oe(e)&&e.ownerSVGElement&&e.getBBox(),i=!ce&&"border-box"===o.boxSizing,r=le.test(o.writingMode||""),s=!n&&ae.test(o.overflowY||""),a=!n&&ae.test(o.overflowX||""),l=n?0:ue(o.paddingTop),c=n?0:ue(o.paddingRight),u=n?0:ue(o.paddingBottom),d=n?0:ue(o.paddingLeft),h=n?0:ue(o.borderTopWidth),p=n?0:ue(o.borderRightWidth),v=n?0:ue(o.borderBottomWidth),f=d+c,g=l+u,y=(n?0:ue(o.borderLeftWidth))+p,b=h+v,m=a?e.offsetHeight-b-e.clientHeight:0,w=s?e.offsetWidth-y-e.clientWidth:0,S=i?f+y:0,D=i?g+b:0,E=n?n.width:ue(o.width)-S-w,N=n?n.height:ue(o.height)-D-m,R=E+f+w+y,C=N+g+m+b,P=Q({devicePixelContentBoxSize:de(Math.round(E*devicePixelRatio),Math.round(N*devicePixelRatio),r),borderBoxSize:de(R,C,r),contentBoxSize:de(E,N,r),contentRect:new te(d,l,E,N)});return se.set(e,P),P},ve=function(e,t,o){var n=pe(e,o),i=n.borderBoxSize,r=n.contentBoxSize,a=n.devicePixelContentBoxSize;switch(t){case s.DEVICE_PIXEL_CONTENT_BOX:return a;case s.BORDER_BOX:return i;default:return r}},fe=function(e){var t=pe(e);this.target=e,this.contentRect=t.contentRect,this.borderBoxSize=Q([t.borderBoxSize]),this.contentBoxSize=Q([t.contentBoxSize]),this.devicePixelContentBoxSize=Q([t.devicePixelContentBoxSize])},ge=function(e){if(ne(e))return 1/0;for(var t=0,o=e.parentNode;o;)t+=1,o=o.parentNode;return t},ye=function(){var e=1/0,t=[];$.forEach((function(o){if(0!==o.activeTargets.length){var n=[];o.activeTargets.forEach((function(t){var o=new fe(t.target),i=ge(t.target);n.push(o),t.lastReportedSize=ve(t.target,t.observedBox),i<e&&(e=i)})),t.push((function(){o.callback.call(o.observer,n,o.observer)})),o.activeTargets.splice(0,o.activeTargets.length)}}));for(var o=0,n=t;o<n.length;o++){(0,n[o])()}return e},be=function(e){$.forEach((function(t){t.activeTargets.splice(0,t.activeTargets.length),t.skippedTargets.splice(0,t.skippedTargets.length),t.observationTargets.forEach((function(o){o.isActive()&&(ge(o.target)>e?t.activeTargets.push(o):t.skippedTargets.push(o))}))}))},me=function(){var e,t=0;for(be(t);$.some((function(e){return e.activeTargets.length>0}));)t=ye(),be(t);return $.some((function(e){return e.skippedTargets.length>0}))&&("function"==typeof ErrorEvent?e=new ErrorEvent("error",{message:Z}):((e=document.createEvent("Event")).initEvent("error",!1,!1),e.message=Z),window.dispatchEvent(e)),t>0},we=[],Se=function(e){if(!J){var t=0,o=document.createTextNode("");new MutationObserver((function(){return we.splice(0).forEach((function(e){return e()}))})).observe(o,{characterData:!0}),J=function(){o.textContent=""+(t?t--:t++)}}we.push(e),J()},De=0,Ee={attributes:!0,characterData:!0,childList:!0,subtree:!0},Ne=["resize","load","transitionend","animationend","animationstart","animationiteration","keyup","keydown","mouseup","mousedown","mouseover","mouseout","blur","focus"],Re=function(e){return void 0===e&&(e=0),Date.now()+e},Ce=!1,Pe=new(function(){function e(){var e=this;this.stopped=!0,this.listener=function(){return e.schedule()}}return e.prototype.run=function(e){var t=this;if(void 0===e&&(e=250),!Ce){Ce=!0;var o,n=Re(e);o=function(){var o=!1;try{o=me()}finally{if(Ce=!1,e=n-Re(),!De)return;o?t.run(1e3):e>0?t.run(e):t.start()}},Se((function(){requestAnimationFrame(o)}))}},e.prototype.schedule=function(){this.stop(),this.run()},e.prototype.observe=function(){var e=this,t=function(){return e.observer&&e.observer.observe(document.body,Ee)};document.body?t():re.addEventListener("DOMContentLoaded",t)},e.prototype.start=function(){var e=this;this.stopped&&(this.stopped=!1,this.observer=new MutationObserver(this.listener),this.observe(),Ne.forEach((function(t){return re.addEventListener(t,e.listener,!0)})))},e.prototype.stop=function(){var e=this;this.stopped||(this.observer&&this.observer.disconnect(),Ne.forEach((function(t){return re.removeEventListener(t,e.listener,!0)})),this.stopped=!0)},e}()),ke=function(e){!De&&e>0&&Pe.start(),!(De+=e)&&Pe.stop()},Ae=function(){function e(e,t){this.target=e,this.observedBox=t||s.CONTENT_BOX,this.lastReportedSize={inlineSize:0,blockSize:0}}return e.prototype.isActive=function(){var e,t=ve(this.target,this.observedBox,!0);return e=this.target,oe(e)||function(e){switch(e.tagName){case"INPUT":if("image"!==e.type)break;case"VIDEO":case"AUDIO":case"EMBED":case"OBJECT":case"CANVAS":case"IFRAME":case"IMG":return!0}return!1}(e)||"inline"!==getComputedStyle(e).display||(this.lastReportedSize=t),this.lastReportedSize.inlineSize!==t.inlineSize||this.lastReportedSize.blockSize!==t.blockSize},e}(),Te=function(e,t){this.activeTargets=[],this.skippedTargets=[],this.observationTargets=[],this.observer=e,this.callback=t},Oe=new WeakMap,Ie=function(e,t){for(var o=0;o<e.length;o+=1)if(e[o].target===t)return o;return-1},Fe=function(){function e(){}return e.connect=function(e,t){var o=new Te(e,t);Oe.set(e,o)},e.observe=function(e,t,o){var n=Oe.get(e),i=0===n.observationTargets.length;Ie(n.observationTargets,t)<0&&(i&&$.push(n),n.observationTargets.push(new Ae(t,o&&o.box)),ke(1),Pe.schedule())},e.unobserve=function(e,t){var o=Oe.get(e),n=Ie(o.observationTargets,t),i=1===o.observationTargets.length;n>=0&&(i&&$.splice($.indexOf(o),1),o.observationTargets.splice(n,1),ke(-1))},e.disconnect=function(e){var t=this,o=Oe.get(e);o.observationTargets.slice().forEach((function(o){return t.unobserve(e,o.target)})),o.activeTargets.splice(0,o.activeTargets.length)},e}(),xe=function(){function e(e){if(0===arguments.length)throw new TypeError("Failed to construct 'ResizeObserver': 1 argument required, but only 0 present.");if("function"!=typeof e)throw new TypeError("Failed to construct 'ResizeObserver': The callback provided as parameter 1 is not a function.");Fe.connect(this,e)}return e.prototype.observe=function(e,t){if(0===arguments.length)throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!ie(e))throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': parameter 1 is not of type 'Element");Fe.observe(this,e,t)},e.prototype.unobserve=function(e){if(0===arguments.length)throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!ie(e))throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': parameter 1 is not of type 'Element");Fe.unobserve(this,e)},e.prototype.disconnect=function(){Fe.disconnect(this)},e.toString=function(){return"function ResizeObserver () { [polyfill code] }"},e}(),Me=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.request=null,t.resizeObserver=null,t.onResize=function(e){e.preventDefault&&e.preventDefault(),t.request=requestAnimationFrame((function(){cancelAnimationFrame(t.request),t.dispatch(new M({scrollX:t.contentWindow.scrollX,scrollY:t.contentWindow.scrollY,width:t.contentWindow.innerWidth,height:t.contentWindow.innerHeight,innerHeight:t.contentWindow.innerHeight,innerWidth:t.contentWindow.innerWidth,view:t.contentWindow,target:e.target||t.container}))}))},t}return o(t,e),t.prototype.attach=function(){this.contentWindow&&this.contentWindow!==Designable.Shared.globalThisPolyfill?this.addEventListener("resize",this.onResize):this.container&&this.container!==document&&(this.resizeObserver=new xe(this.onResize),this.resizeObserver.observe(this.container))},t.prototype.detach=function(){this.contentWindow&&this.contentWindow!==Designable.Shared.globalThisPolyfill?this.removeEventListener("resize",this.onResize):this.resizeObserver&&this.container&&this.container!==document&&(this.resizeObserver.unobserve(this.container),this.resizeObserver.disconnect())},t}(Designable.Shared.EventDriver),We=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.request=null,t.onScroll=function(e){e.preventDefault(),t.request=Designable.Shared.globalThisPolyfill.requestAnimationFrame((function(){t.dispatch(new W({scrollX:t.contentWindow.scrollX,scrollY:t.contentWindow.scrollY,width:t.contentWindow.document.body.clientWidth,height:t.contentWindow.document.body.clientHeight,innerHeight:t.contentWindow.innerHeight,innerWidth:t.contentWindow.innerWidth,view:t.contentWindow,target:e.target})),cancelAnimationFrame(t.request)}))},t}return o(t,e),t.prototype.attach=function(){this.addEventListener("scroll",this.onScroll)},t.prototype.detach=function(){this.removeEventListener("scroll",this.onScroll)},t}(Designable.Shared.EventDriver);function Be(e){var t=e.target,o=t.tagName,n=!0;return(t.isContentEditable||("INPUT"===o||"TEXTAREA"===o||"SELECT"===o||customElements.get(o.toLocaleLowerCase()))&&!t.readOnly)&&(n=!1),n}var Le,Xe=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onKeyDown=function(e){Be(e)&&t.dispatch(new f(e))},t.onKeyUp=function(e){t.dispatch(new g(e))},t}return o(t,e),t.prototype.attach=function(){this.addEventListener("keydown",this.onKeyDown,{mode:"onlyParent"}),this.addEventListener("keyup",this.onKeyUp,{mode:"onlyParent"})},t.prototype.detach=function(){this.removeEventListener("keydown",this.onKeyDown,{mode:"onlyParent"}),this.removeEventListener("keyup",this.onKeyUp,{mode:"onlyParent"})},t}(Designable.Shared.EventDriver),Ye=function(e){return String(e).replace(/\s+/g,"_").toLocaleLowerCase()},ze=function(e,t){if(Designable.Shared.isPlainObj(e)&&Designable.Shared.isPlainObj(t))return Designable.Shared.each(t,(function(t,o){var n=Ye(o),i=ze(e[o]||e[n],t);e[n]=i})),e;if(Designable.Shared.isPlainObj(t)){var o=Array.isArray(t)?[]:{};return Designable.Shared.each(t,(function(e,t){var n=ze(void 0,e);o[Ye(t)]=n})),o}return t},qe=function(e){var t=Ke.value,o=Ye(e);return je.value[o]?o:(Designable.Shared.each(je.value,(function(e,n){if(n.indexOf(o)>-1||String(o).indexOf(n)>-1)return t=n,!1})),t)},Ve=function(e,t){var o=function(t){return e.includes(t)};Designable.Shared.each(t,(function(n){if(n&&Vt(n)){var i=n.Behavior;Designable.Shared.each(i,(function(n){if(!o(n)){var i=n.name;Designable.Shared.each(n.extends,(function(n){var r=function(e){for(var o in t)for(var n=t[o].Behavior,i=0;i<n.length;i++)if(n[i].name===e)return n[i]}(n);if(!r)throw new Error("No "+n+" behavior that "+i+" depends on");o(r)||e.unshift(r)})),e.push(n)}}))}}))},Ue=Formily.Reactive.observable.ref([]),_e=Formily.Reactive.observable.ref({}),je=Formily.Reactive.observable.ref({}),Ke=Formily.Reactive.observable.ref(function(){var e;return Designable.Shared.globalThisPolyfill.navigator&&(Designable.Shared.globalThisPolyfill.navigator.browserlanguage||(null===(e=Designable.Shared.globalThisPolyfill.navigator)||void 0===e?void 0:e.language))||"en"}()),He={setDesignerLanguage:function(e){Ke.value=e},setDesignerBehaviors:function(e){Ue.value=e.reduce((function(e,t){return Vt(t)?e.concat(t.Behavior):Ut(t)?e.concat(t):e}),[])},getDesignerBehaviors:function(e){return Ue.value.filter((function(t){return t.selector(e)}))},getDesignerIcon:function(e){return _e[e]},getDesignerLanguage:function(){return qe(Ke.value)},getDesignerMessage:function(e,t){var o=qe(Ke.value),n=t?t[o]:je.value[o];if(n)return Formily.Path.Path.getIn(n,Ye(e));for(var i in je.value){var r=Formily.Path.Path.getIn(je.value[i],Ye(e));if(r)return r}},registerDesignerIcons:function(e){Object.assign(_e,e)},registerDesignerLocales:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.forEach((function(e){ze(je.value,e)}))},registerDesignerBehaviors:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=[];e.forEach((function(e){Ve(o,e)})),o.length&&(Ue.value=o)}},Ge=He,$e=new Map,Ze=new Map,Je=function(e){e.parent&&(e.parent.children=e.parent.children.filter((function(t){return t!==e})))},Qe=function(e,t){var o=function(e){e.depth=e.parent?e.parent.depth+1:0,e.children.forEach(o)},n=function(e){e.parent=t,e.root=t.root,o(e)},i=function(e){n(e),Qe(e.children,e)};return e.map((function(e){return e===t||(t.isSourceNode?i(e):e.isSourceNode?(e=e.clone(t),o(e)):!e.isRoot&&e.isInOperation?(e.root.operation.selection.remove(e),Je(e),n(e)):i(e),$e.has(e.id)||($e.set(e.id,e),Ze.set(e.componentName,e.designerProps))),e}))},et=function(e,t){return Qe([e],t)[0]},tt=function(){function e(t,o){if(this.depth=0,this.hidden=!1,this.componentName="NO_NAME_COMPONENT",this.sourceName="",this.props={},this.children=[],t instanceof e)return t;this.id=t.id||Designable.Shared.uid(),o?(this.parent=o,this.depth=o.depth+1,this.root=o.root,$e.set(this.id,this)):(this.root=this,this.operation=t.operation,this.isSelfSourceNode=t.isSourceNode||!1,$e.set(this.id,this)),t&&this.from(t),this.makeObservable()}return e.prototype.makeObservable=function(){Formily.Reactive.define(this,{componentName:Formily.Reactive.observable.ref,props:Formily.Reactive.observable,hidden:Formily.Reactive.observable.ref,children:Formily.Reactive.observable.shallow,designerProps:Formily.Reactive.observable.computed,designerLocales:Formily.Reactive.observable.computed,wrap:Formily.Reactive.action,prepend:Formily.Reactive.action,append:Formily.Reactive.action,insertAfter:Formily.Reactive.action,insertBefore:Formily.Reactive.action,remove:Formily.Reactive.action,setProps:Formily.Reactive.action,setChildren:Formily.Reactive.action,setComponentName:Formily.Reactive.action})},Object.defineProperty(e.prototype,"designerProps",{get:function(){var e=this;return Ge.getDesignerBehaviors(this).reduce((function(t,o){return o.designerProps?(Object.assign(t,(n=e,i=o.designerProps,Designable.Shared.isFn(i)?i(n):i)),t):t;var n,i}),{})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"designerLocales",{get:function(){return Ge.getDesignerBehaviors(this).reduce((function(e,t){return t.designerLocales?(ze(e,t.designerLocales),e):e}),{})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"previous",{get:function(){if(this.parent!==this&&this.parent)return this.parent.children[this.index-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"next",{get:function(){if(this.parent!==this&&this.parent)return this.parent.children[this.index+1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"siblings",{get:function(){var e=this;return this.parent?this.parent.children.filter((function(t){return t!==e})):[]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"index",{get:function(){return this.parent!==this&&this.parent?this.parent.children.indexOf(this):0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"descendants",{get:function(){return this.children.reduce((function(e,t){return e.concat(t).concat(t.descendants)}),[])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRoot",{get:function(){return this===this.root},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isInOperation",{get:function(){var e;return!!(null===(e=this.root)||void 0===e?void 0:e.operation)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastChild",{get:function(){return this.children[this.children.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstChild",{get:function(){return this.children[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isSourceNode",{get:function(){return this.root.isSelfSourceNode},enumerable:!1,configurable:!0}),e.prototype.getPrevious=function(e){return void 0===e&&(e=1),this.parent.children[this.index-e]},e.prototype.getAfter=function(e){return void 0===e&&(e=1),this.parent.children[this.index+e]},e.prototype.getSibling=function(e){return void 0===e&&(e=0),this.parent.children[e]},e.prototype.getParents=function(e){var t=e||this;return(null==t?void 0:t.parent)?[t.parent].concat(this.getParents(t.parent)):[]},e.prototype.getParentByDepth=function(e){void 0===e&&(e=0);var t=this.parent;return(null==t?void 0:t.depth)===e?t:null==t?void 0:t.getParentByDepth(e)},e.prototype.getMessage=function(e){return Ge.getDesignerMessage(e,this.designerLocales)},e.prototype.isMyAncestor=function(e){return e!==this&&this.parent!==e&&e.contains(this)},e.prototype.isMyParent=function(e){return this.parent===e},e.prototype.isMyParents=function(e){return e!==this&&(this.isMyParent(e)||this.isMyAncestor(e))},e.prototype.isMyChild=function(e){return e.isMyParent(this)},e.prototype.isMyChildren=function(e){return e.isMyParents(this)},e.prototype.takeSnapshot=function(e){var t;(null===(t=this.root)||void 0===t?void 0:t.operation)&&this.root.operation.snapshot(e)},e.prototype.triggerMutation=function(e,t,o){var n;if(null===(n=this.root)||void 0===n?void 0:n.operation){var i=this.root.operation.dispatch(e,t)||o;return this.takeSnapshot(null==e?void 0:e.type),i}if(Designable.Shared.isFn(t))return t()},e.prototype.find=function(e){if(e(this))return this;var t=void 0;return this.eachChildren((function(o){if(e(o))return t=o,!1})),t},e.prototype.findAll=function(e){var t=[];return e(this)&&t.push(this),this.eachChildren((function(o){e(o)&&t.push(o)})),t},e.prototype.distanceTo=function(e){return this.root!==e.root||this.parent!==e.parent?1/0:Math.abs(this.index-e.index)},e.prototype.crossSiblings=function(e){if(this.parent!==e.parent)return[];for(var t=Math.min(this.index,e.index),o=Math.max(this.index,e.index),n=[],i=t+1;i<o;i++)n.push(this.parent.children[i]);return n},e.prototype.allowSibling=function(e){var t,o,n;return!1!==(null===(o=null===(t=this.designerProps)||void 0===t?void 0:t.allowSiblings)||void 0===o?void 0:o.call(t,this,e))&&(null===(n=this.parent)||void 0===n?void 0:n.allowAppend(e))},e.prototype.allowDrop=function(e){return!Designable.Shared.isFn(this.designerProps.allowDrop)||this.designerProps.allowDrop(e)},e.prototype.allowAppend=function(e){var t,o,n,i=this;return!!(null===(t=this.designerProps)||void 0===t?void 0:t.droppable)&&(!1!==(null===(n=null===(o=this.designerProps)||void 0===o?void 0:o.allowAppend)||void 0===n?void 0:n.call(o,this,e))&&(!e.some((function(e){return!e.allowDrop(i)}))&&(this.root,!0)))},e.prototype.allowClone=function(){var e;return this!==this.root&&(null===(e=this.designerProps.cloneable)||void 0===e||e)},e.prototype.allowDrag=function(){var e;return!(this===this.root&&!this.isSourceNode)&&(null===(e=this.designerProps.draggable)||void 0===e||e)},e.prototype.allowResize=function(){if(this===this.root&&!this.isSourceNode)return!1;var e=this.designerProps.resizable;return!!e&&(e.width&&e.height?["x","y"]:e.width?["x"]:["y"])},e.prototype.allowTranslate=function(){if(this===this.root&&!this.isSourceNode)return!1;var e=this.designerProps.translatable;return!(!(null==e?void 0:e.x)||!(null==e?void 0:e.y))},e.prototype.allowDelete=function(){var e;return this!==this.root&&(null===(e=this.designerProps.deletable)||void 0===e||e)},e.prototype.findById=function(e){var t;if(e)return this.id===e?this:(null===(t=this.children)||void 0===t?void 0:t.length)>0?$e.get(e):void 0},e.prototype.contains=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return t.every((function(t){return t===e||(null==t?void 0:t.parent)===e||(null==t?void 0:t.getParentByDepth(e.depth))===e}))},e.prototype.eachChildren=function(e){if(Designable.Shared.isFn(e))for(var t=0;t<this.children.length;t++){var o=this.children[t];if(!1===e(o))return;o.eachChildren(e)}},e.prototype.resetNodesParent=function(e,t){var o=this;return Qe(e.filter((function(e){return e!==o})),t)},e.prototype.setProps=function(e){var t=this;return this.triggerMutation(new A({target:this,source:null}),(function(){Object.assign(t.props,e)}))},e.prototype.setComponentName=function(e){this.componentName=e},e.prototype.prepend=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];if(t.some((function(t){return t.contains(e)})))return[];var n=t.map((function(e){return e.parent})),i=this.resetNodesParent(t,this);return i.length?this.triggerMutation(new N({originSourceParents:n,target:this,source:i}),(function(){return e.children=i.concat(e.children),i}),[]):[]},e.prototype.append=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];if(t.some((function(t){return t.contains(e)})))return[];var n=t.map((function(e){return e.parent})),i=this.resetNodesParent(t,this);return i.length?this.triggerMutation(new I({originSourceParents:n,target:this,source:i}),(function(){return e.children=e.children.concat(i),i}),[]):[]},e.prototype.wrap=function(e){var t=this;if(e!==this){var o=this.parent;return this.triggerMutation(new T({target:this,source:e}),(function(){return et(t,e),et(e,o),e}))}},e.prototype.insertAfter=function(){for(var e,t=this,o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];var i=this.parent;if(o.some((function(e){return e.contains(t)})))return[];if(null===(e=null==i?void 0:i.children)||void 0===e?void 0:e.length){var r=o.map((function(e){return e.parent})),s=this.resetNodesParent(o,i);return s.length?this.triggerMutation(new S({originSourceParents:r,target:this,source:s}),(function(){return i.children=i.children.reduce((function(e,o){return o===t?e.concat([o]).concat(s):e.concat([o])}),[]),s}),[]):[]}return[]},e.prototype.insertBefore=function(){for(var e,t=this,o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];var i=this.parent;if(o.some((function(e){return e.contains(t)})))return[];if(null===(e=null==i?void 0:i.children)||void 0===e?void 0:e.length){var r=o.map((function(e){return e.parent})),s=this.resetNodesParent(o,i);return s.length?this.triggerMutation(new D({originSourceParents:r,target:this,source:s}),(function(){return i.children=i.children.reduce((function(e,o){return o===t?e.concat(s).concat([o]):e.concat([o])}),[]),s}),[]):[]}return[]},e.prototype.insertChildren=function(e){for(var t,o=this,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(n.some((function(e){return e.contains(o)})))return[];if(null===(t=this.children)||void 0===t?void 0:t.length){var r=n.map((function(e){return e.parent})),s=this.resetNodesParent(n,this);return s.length?this.triggerMutation(new E({originSourceParents:r,target:this,source:s}),(function(){return o.children=o.children.reduce((function(t,o,n){return n===e?t.concat(s).concat([o]):t.concat([o])}),[]),s}),[]):[]}return[]},e.prototype.setChildren=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var n=t.map((function(e){return e.parent})),i=this.resetNodesParent(t,this);return this.triggerMutation(new k({originSourceParents:n,target:this,source:i}),(function(){return e.children=i,i}),[])},e.prototype.setNodeChildren=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.setChildren.apply(this,r(e))},e.prototype.remove=function(){var e=this;return this.triggerMutation(new R({target:this,source:null}),(function(){Je(e),$e.delete(e.id)}))},e.prototype.clone=function(t){var o=new e({id:Designable.Shared.uid(),componentName:this.componentName,sourceName:this.sourceName,props:Formily.Reactive.toJS(this.props),children:[]},t||this.parent);return o.children=Qe(this.children.map((function(e){return e.clone(o)})),o),this.triggerMutation(new O({target:this,source:o}),(function(){return o}))},e.prototype.from=function(t){var o=this;if(t)return this.triggerMutation(new F({target:this,source:t}),(function(){var n,i,r;t.id&&t.id!==o.id&&($e.delete(o.id),$e.set(t.id,o),o.id=t.id),t.componentName&&(o.componentName=t.componentName),o.props=null!==(n=t.props)&&void 0!==n?n:{},t.hidden&&(o.hidden=t.hidden),t.children&&(o.children=(null===(r=null===(i=t.children)||void 0===i?void 0:i.map)||void 0===r?void 0:r.call(i,(function(t){return new e(t,o)})))||[])}))},e.prototype.serialize=function(){return{id:this.id,componentName:this.componentName,sourceName:this.sourceName,props:Formily.Reactive.toJS(this.props),hidden:this.hidden,children:this.children.map((function(e){return e.serialize()}))}},e.create=function(t,o){return new e(t,o)},e.findById=function(e){return $e.get(e)},e}(),ot=function(){function e(){this.store=new Map}return e.prototype._queryAll=function(e,t){if(!e)return[];var o=function(e){return Array.from(e||[])}(null==e?void 0:e.querySelectorAll(t)),n=t+"@ALL",i=this.store.get(n);return i?i.set(e,o):this.store.set(n,new WeakMap([[e,o]])),o},e.prototype._query=function(e,t){if(e){var o=null==e?void 0:e.querySelector(t),n=this.store.get(t);return n?n.set(e,o):this.store.set(t,new WeakMap([[e,o]])),o}},e.prototype._clean=function(e,t){var o=this.store.get(t);o&&o.delete(e)},e.prototype.queryAll=function(e,t){var o=t+"@ALL",n=this.store.get(o),i={current:null};return n?(i.current=n.get(e),Array.isArray(i.current)?0===i.current.length||i.current.some((function(e){return!e.isConnected}))?(this._clean(e,o),this._queryAll(e,t)):i.current:(this._clean(e,o),this._queryAll(e,t))):this._queryAll(e,t)},e.prototype.query=function(e,t){var o=this.store.get(t),n={current:null};return o?(n.current=o.get(e),n.current&&!Array.isArray(n.current)&&n.current.isConnected?n.current:(this._clean(e,t),this._query(e,t))):this._query(e,t)},e}(),nt=function(){function e(e){this.scrollX=0,this.scrollY=0,this.width=0,this.height=0,this.workspace=e.workspace,this.engine=e.engine,this.viewportElement=e.viewportElement,this.contentWindow=e.contentWindow,this.nodeIdAttrName=e.nodeIdAttrName,this.selector=new ot,this.digestViewport(),this.makeObservable(),this.attachEvents()}return Object.defineProperty(e.prototype,"isScrollLeft",{get:function(){return 0===this.scrollX},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isScrollTop",{get:function(){return 0===this.scrollY},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isScrollRight",{get:function(){var e,t,o,n;return this.isIframe?this.width+this.scrollX>=(null===(o=null===(t=null===(e=this.contentWindow)||void 0===e?void 0:e.document)||void 0===t?void 0:t.body)||void 0===o?void 0:o.scrollWidth):this.viewportElement?this.width+this.scrollX>=(null===(n=this.viewportElement)||void 0===n?void 0:n.scrollWidth):void 0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isScrollBottom",{get:function(){var e,t,o,n;return this.isIframe?this.height+this.scrollY>=(null===(o=null===(t=null===(e=this.contentWindow)||void 0===e?void 0:e.document)||void 0===t?void 0:t.body)||void 0===o?void 0:o.scrollHeight):this.viewportElement?this.height+this.scrollY>=(null===(n=this.viewportElement)||void 0===n?void 0:n.scrollHeight):void 0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"viewportRoot",{get:function(){var e,t;return this.isIframe?null===(t=null===(e=this.contentWindow)||void 0===e?void 0:e.document)||void 0===t?void 0:t.body:this.viewportElement},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isMaster",{get:function(){return this.contentWindow===Designable.Shared.globalThisPolyfill},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isIframe",{get:function(){var e;return!!(null===(e=this.contentWindow)||void 0===e?void 0:e.frameElement)&&!this.isMaster},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scrollContainer",{get:function(){return this.isIframe?this.contentWindow:this.viewportElement},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rect",{get:function(){var e=this.viewportElement;if(e)return this.getElementRect(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"innerRect",{get:function(){var e=this.rect;return"undefined"!=typeof DOMRect&&new DOMRect(0,0,null==e?void 0:e.width,null==e?void 0:e.height)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"offsetX",{get:function(){var e=this.rect;return e?e.x:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"offsetY",{get:function(){var e=this.rect;return e?e.y:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){if(!this.viewportElement)return 1;var e=this.viewportElement.getBoundingClientRect(),t=this.viewportElement.offsetWidth;return Math.round(e.width/t)},enumerable:!1,configurable:!0}),e.prototype.digestViewport=function(){var e,t,o,n,i,r,s,a;this.isIframe?(this.scrollX=(null===(e=this.contentWindow)||void 0===e?void 0:e.scrollX)||0,this.scrollY=(null===(t=this.contentWindow)||void 0===t?void 0:t.scrollY)||0,this.width=(null===(o=this.contentWindow)||void 0===o?void 0:o.innerWidth)||0,this.height=(null===(n=this.contentWindow)||void 0===n?void 0:n.innerHeight)||0):this.viewportElement&&(this.scrollX=(null===(i=this.viewportElement)||void 0===i?void 0:i.scrollLeft)||0,this.scrollY=(null===(r=this.viewportElement)||void 0===r?void 0:r.scrollTop)||0,this.width=(null===(s=this.viewportElement)||void 0===s?void 0:s.clientWidth)||0,this.height=(null===(a=this.viewportElement)||void 0===a?void 0:a.clientHeight)||0)},e.prototype.elementFromPoint=function(e){var t;if(null===(t=this.contentWindow)||void 0===t?void 0:t.document)return this.contentWindow.document.elementFromPoint(e.x,e.y)},e.prototype.matchViewport=function(e){var t;return this.isIframe?e===this.viewportElement||e===this.contentWindow||e===(null===(t=this.contentWindow)||void 0===t?void 0:t.document):e===this.viewportElement},e.prototype.attachEvents=function(){var e=this,t=this.engine;Designable.Shared.cancelIdle(this.attachRequest),this.attachRequest=Designable.Shared.requestIdle((function(){t&&(e.isIframe?e.workspace.attachEvents(e.contentWindow,e.contentWindow):Designable.Shared.isHTMLElement(e.viewportElement)&&e.workspace.attachEvents(e.viewportElement,e.contentWindow))}))},e.prototype.detachEvents=function(){this.isIframe?(this.workspace.detachEvents(this.contentWindow),this.workspace.detachEvents(this.viewportElement)):this.viewportElement&&this.workspace.detachEvents(this.viewportElement)},e.prototype.onMount=function(e,t){this.viewportElement=e,this.contentWindow=t,this.attachEvents(),this.digestViewport()},e.prototype.onUnmount=function(){this.detachEvents()},e.prototype.isPointInViewport=function(e,t){return!!this.rect&&(!!this.containsElement(document.elementFromPoint(e.x,e.y))&&Designable.Shared.isPointInRect(e,this.rect,t))},e.prototype.isPointInViewportArea=function(e,t){return!!this.rect&&Designable.Shared.isPointInRect(e,this.rect,t)},e.prototype.isOffsetPointInViewport=function(e,t){return!!this.innerRect&&(!!this.containsElement(document.elementFromPoint(e.x,e.y))&&Designable.Shared.isPointInRect(e,this.innerRect,t))},e.prototype.makeObservable=function(){Formily.Reactive.define(this,{scrollX:Formily.Reactive.observable.ref,scrollY:Formily.Reactive.observable.ref,width:Formily.Reactive.observable.ref,height:Formily.Reactive.observable.ref,digestViewport:Formily.Reactive.action,viewportElement:Formily.Reactive.observable.ref,contentWindow:Formily.Reactive.observable.ref})},e.prototype.findElementById=function(e){return this.selector.query(this.viewportRoot,"*["+this.nodeIdAttrName+"='"+e+"']\n      ")},e.prototype.findElementsById=function(e){return e?this.selector.queryAll(this.viewportRoot,"*["+this.nodeIdAttrName+"='"+e+"']\n      "):[]},e.prototype.containsElement=function(e){var t=this.viewportElement;return t===e||(null==t?void 0:t.contains(e))},e.prototype.getOffsetPoint=function(e){var t,o,n,i,r,s,a,l;return this.isIframe?{x:e.x-this.offsetX+(null!==(o=null===(t=this.contentWindow)||void 0===t?void 0:t.scrollX)&&void 0!==o?o:0),y:e.y-this.offsetY+(null!==(i=null===(n=this.contentWindow)||void 0===n?void 0:n.scrollY)&&void 0!==i?i:0)}:{x:e.x-this.offsetX+(null!==(s=null===(r=this.viewportElement)||void 0===r?void 0:r.scrollLeft)&&void 0!==s?s:0),y:e.y-this.offsetY+(null!==(l=null===(a=this.viewportElement)||void 0===a?void 0:a.scrollTop)&&void 0!==l?l:0)}},e.prototype.getElementRect=function(e){var t=e.getBoundingClientRect(),o=e.offsetWidth?e.offsetWidth:t.width,n=e.offsetHeight?e.offsetHeight:t.height;return"undefined"!=typeof DOMRect&&new DOMRect(t.x,t.y,1!==this.scale?o:t.width,1!==this.scale?n:t.height)},e.prototype.getElementRectById=function(e){var t=this,o=this.findElementsById(e),n=Designable.Shared.calcBoundingRect(o.map((function(e){return t.getElementRect(e)})));if(n)return this.isIframe?"undefined"!=typeof DOMRect&&new DOMRect(n.x+this.offsetX,n.y+this.offsetY,n.width,n.height):"undefined"!=typeof DOMRect&&new DOMRect(n.x,n.y,n.width,n.height)},e.prototype.getElementOffsetRectById=function(e){var t=this,o=this.findElementsById(e);if(o.length){var n=Designable.Shared.calcBoundingRect(o.map((function(e){return t.getElementRect(e)})));return n?this.isIframe?"undefined"!=typeof DOMRect&&new DOMRect(n.x+this.contentWindow.scrollX,n.y+this.contentWindow.scrollY,n.width,n.height):"undefined"!=typeof DOMRect&&new DOMRect((n.x-this.offsetX+this.viewportElement.scrollLeft)/this.scale,(n.y-this.offsetY+this.viewportElement.scrollTop)/this.scale,n.width,n.height):void 0}},e.prototype.getValidNodeElement=function(e){var t=this,o=function(e){if(e){var n=t.findElementById(e.id);return n||o(e.parent)}};return o(e)},e.prototype.getChildrenRect=function(e){var t,o=this;if(null===(t=null==e?void 0:e.children)||void 0===t?void 0:t.length)return Designable.Shared.calcBoundingRect(e.children.reduce((function(e,t){var n=o.getValidNodeRect(t);return n?e.concat(n):e}),[]))},e.prototype.getChildrenOffsetRect=function(e){var t,o=this;if(null===(t=null==e?void 0:e.children)||void 0===t?void 0:t.length)return Designable.Shared.calcBoundingRect(e.children.reduce((function(e,t){var n=o.getValidNodeOffsetRect(t);return n?e.concat(n):e}),[]))},e.prototype.getValidNodeRect=function(e){if(e){var t=this.getElementRectById(e.id);return e&&e===e.root?t?Designable.Shared.calcBoundingRect([this.rect,t]):this.rect:t||this.getChildrenRect(e)}},e.prototype.getValidNodeOffsetRect=function(e){if(e){var t=this.getElementOffsetRectById(e.id);return e&&e===e.root?t?Designable.Shared.calcBoundingRect([this.innerRect,t]):this.innerRect:t||this.getChildrenOffsetRect(e)}},e.prototype.getValidNodeLayout=function(e){var t,o;return e?(null===(o=null===(t=e.parent)||void 0===t?void 0:t.designerProps)||void 0===o?void 0:o.inlineChildrenLayout)?"horizontal":Designable.Shared.calcElementLayout(this.findElementById(e.id)):"vertical"},e}(),it=function(){function e(e){this.selected=[],e.selected&&(this.selected=e.selected),e.operation&&(this.operation=e.operation),this.makeObservable()}return e.prototype.makeObservable=function(){Formily.Reactive.define(this,{selected:Formily.Reactive.observable,select:Formily.Reactive.action,batchSelect:Formily.Reactive.action,add:Formily.Reactive.action,remove:Formily.Reactive.action,clear:Formily.Reactive.action,crossAddTo:Formily.Reactive.action})},e.prototype.trigger=function(e){return void 0===e&&(e=C),this.operation.dispatch(new e({target:this.operation.tree,source:this.operation.getSelectedNodes()}))},e.prototype.select=function(e){if(Designable.Shared.isStr(e)){if(1===this.selected.length&&this.selected.includes(e))return void this.trigger(C);this.selected=[e],this.trigger(C)}else this.select(null==e?void 0:e.id)},e.prototype.safeSelect=function(e){e&&this.select(e)},e.prototype.mapIds=function(e){return Designable.Shared.isArr(e)?e.map((function(e){return Designable.Shared.isStr(e)?e:null==e?void 0:e.id})):[]},e.prototype.batchSelect=function(e){this.selected=this.mapIds(e),this.trigger(C)},e.prototype.batchSafeSelect=function(e){(null==e?void 0:e.length)&&this.batchSelect(e)},Object.defineProperty(e.prototype,"first",{get:function(){if(this.selected&&this.selected.length)return this.selected[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"last",{get:function(){if(this.selected&&this.selected.length)return this.selected[this.selected.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.selected.length},enumerable:!1,configurable:!0}),e.prototype.add=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];this.mapIds(t).forEach((function(t){Designable.Shared.isStr(t)?e.selected.includes(t)||e.selected.push(t):e.add(null==t?void 0:t.id)})),this.trigger()},e.prototype.crossAddTo=function(e){var t=this;if(e.parent){var o=this.operation.getSelectedNodes();if(this.has(e))this.remove(e);else{var n=o.reduce((function(t,o){return o.distanceTo(e)<t.distanceTo(e)?o:t}),o[0]);if(n)e.crossSiblings(n).forEach((function(e){t.selected.includes(e.id)||t.selected.push(e.id)}));this.selected.includes(e.id)||this.selected.push(e.id)}}},e.prototype.remove=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];this.mapIds(t).forEach((function(t){Designable.Shared.isStr(t)?e.selected=e.selected.filter((function(e){return e!==t})):e.remove(null==t?void 0:t.id)})),this.trigger(P)},e.prototype.has=function(){for(var e=this,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return this.mapIds(t).some((function(t){return Designable.Shared.isStr(t)?e.selected.includes(t):!!(null==t?void 0:t.id)&&e.has(null==t?void 0:t.id)}))},e.prototype.clear=function(){this.selected=[],this.trigger(P)},e}(),rt=function(){function e(e){this.node=null,this.operation=null==e?void 0:e.operation,this.makeObservable()}return e.prototype.setHover=function(e){this.node=e||null,this.trigger()},e.prototype.clear=function(){this.node=null},e.prototype.trigger=function(){if(this.operation)return this.operation.dispatch(new w({target:this.operation.tree,source:this.node}))},e.prototype.makeObservable=function(){Formily.Reactive.define(this,{node:Formily.Reactive.observable.ref,setHover:Formily.Reactive.action,clear:Formily.Reactive.action})},e}();e.ClosestPosition=void 0,(Le=e.ClosestPosition||(e.ClosestPosition={})).Before="BEFORE",Le.ForbidBefore="FORBID_BEFORE",Le.After="After",Le.ForbidAfter="FORBID_AFTER",Le.Upper="UPPER",Le.ForbidUpper="FORBID_UPPER",Le.Under="UNDER",Le.ForbidUnder="FORBID_UNDER",Le.Inner="INNER",Le.ForbidInner="FORBID_INNER",Le.InnerAfter="INNER_AFTER",Le.ForbidInnerAfter="FORBID_INNER_AFTER",Le.InnerBefore="INNER_BEFORE",Le.ForbidInnerBefore="FORBID_INNER_BEFORE",Le.Forbid="FORBID";var st,at,lt=function(){function t(e){this.dragNodes=[],this.touchNode=null,this.dropNode=null,this.closestNode=null,this.closestRect=null,this.closestOffsetRect=null,this.closestDirection=null,this.sensitive=!0,this.forceBlock=!1,this.viewport=null,this.operation=e.operation,this.viewport=e.viewport,this.sensitive=e.sensitive,this.forceBlock=e.forceBlock,this.rootNode=this.operation.tree,this.makeObservable()}return t.prototype.getClosestLayout=function(){return this.viewport.getValidNodeLayout(this.closestNode)},t.prototype.getClosestPosition=function(t){var o=this,n=this.closestNode;if(!n)return e.ClosestPosition.Forbid;var i=this.viewport.getValidNodeRect(n),s="horizontal"===this.getClosestLayout();if(i){var a,l=Designable.Shared.isNearAfter(t,i,!this.forceBlock&&s),c=function(e){var t;if(e)return(null===(t=e.parent)||void 0===t?void 0:t.allowSibling(o.dragNodes))?e.parent:c(e.parent)};return Designable.Shared.isPointInRect(t,i,this.sensitive)?n.allowAppend(this.dragNodes)?n.contains.apply(n,r(this.dragNodes))?l?e.ClosestPosition.InnerAfter:e.ClosestPosition.InnerBefore:e.ClosestPosition.Inner:n.allowSibling(this.dragNodes)?s?l?e.ClosestPosition.After:e.ClosestPosition.Before:l?e.ClosestPosition.Under:e.ClosestPosition.Upper:((a=c(n))&&(this.closestNode=a),s?a?l?e.ClosestPosition.After:e.ClosestPosition.Before:l?e.ClosestPosition.ForbidAfter:e.ClosestPosition.ForbidBefore:a?l?e.ClosestPosition.Under:e.ClosestPosition.Upper:l?e.ClosestPosition.ForbidUnder:e.ClosestPosition.ForbidUpper):n===n.root?l?e.ClosestPosition.InnerAfter:e.ClosestPosition.InnerBefore:n.allowSibling(this.dragNodes)?s?l?e.ClosestPosition.After:e.ClosestPosition.Before:l?e.ClosestPosition.Under:e.ClosestPosition.Upper:((a=c(n))&&(this.closestNode=a),s?a?l?e.ClosestPosition.After:e.ClosestPosition.Before:l?e.ClosestPosition.ForbidAfter:e.ClosestPosition.ForbidBefore:a?l?e.ClosestPosition.Under:e.ClosestPosition.Upper:l?e.ClosestPosition.ForbidUnder:e.ClosestPosition.ForbidUpper)}},t.prototype.setClosestPosition=function(e){this.closestDirection=e},t.prototype.getClosestNode=function(e){var t,o,n=this;if(this.touchNode){var i=this.viewport.getValidNodeRect(this.touchNode);if(!i)return;if(null===(o=null===(t=this.touchNode)||void 0===t?void 0:t.children)||void 0===o?void 0:o.length){var r=Designable.Shared.calcDistancePointToEdge(e,i),s=this.touchNode;return this.touchNode.eachChildren((function(t){var o=n.viewport.getElementRectById(t.id);if(o){var i=Designable.Shared.isPointInRect(e,o,n.sensitive)?0:Designable.Shared.calcDistanceOfPointToRect(e,o);i<=r&&(r=i,s=t)}})),s}return this.touchNode}return null},t.prototype.setClosestNode=function(e){this.closestNode=e},t.prototype.getClosestRect=function(){var t=this.closestNode,o=this.closestDirection;if(t&&o){var n=this.viewport.getValidNodeRect(t);return o===e.ClosestPosition.InnerAfter||o===e.ClosestPosition.InnerBefore?this.viewport.getChildrenRect(t):n}},t.prototype.setClosestRect=function(e){this.closestRect=e},t.prototype.getClosestOffsetRect=function(){var t=this.closestNode,o=this.closestDirection;if(t&&o){var n=this.viewport.getValidNodeOffsetRect(t);return o===e.ClosestPosition.InnerAfter||o===e.ClosestPosition.InnerBefore?this.viewport.getChildrenOffsetRect(t):n}},t.prototype.setClosestOffsetRect=function(e){this.closestOffsetRect=e},t.prototype.setDragNodes=function(e){void 0===e&&(e=[]),this.dragNodes=e,this.trigger(new b({target:this.operation.tree,source:e}))},t.prototype.setTouchNode=function(e){this.touchNode=e,e||(this.closestNode=null,this.closestDirection=null,this.closestOffsetRect=null,this.closestRect=null)},t.prototype.calculate=function(e){var t=e.point,o=e.touchNode,n=e.closestNode,i=e.closestDirection;this.setTouchNode(o),this.closestNode=n||this.getClosestNode(t),this.closestDirection=i||this.getClosestPosition(t),this.closestRect=this.getClosestRect(),this.closestOffsetRect=this.getClosestOffsetRect()},t.prototype.setDropNode=function(e){this.dropNode=e,this.trigger(new m({target:this.operation.tree,source:e}))},t.prototype.trigger=function(e){if(this.operation)return this.operation.dispatch(e)},t.prototype.clear=function(){this.dragNodes=[],this.touchNode=null,this.dropNode=null,this.closestNode=null,this.closestDirection=null,this.closestOffsetRect=null,this.closestRect=null},t.prototype.makeObservable=function(){Formily.Reactive.define(this,{dragNodes:Formily.Reactive.observable.shallow,touchNode:Formily.Reactive.observable.ref,closestNode:Formily.Reactive.observable.ref,closestDirection:Formily.Reactive.observable.ref,closestRect:Formily.Reactive.observable.ref,setDragNodes:Formily.Reactive.action,setTouchNode:Formily.Reactive.action,setDropNode:Formily.Reactive.action,setClosestNode:Formily.Reactive.action,setClosestPosition:Formily.Reactive.action,setClosestOffsetRect:Formily.Reactive.action,setClosestRect:Formily.Reactive.action,clear:Formily.Reactive.action,calculate:Formily.Reactive.action})},t}(),ct=function(){function e(e){this.requests={snapshot:null},this.engine=e.engine,this.workspace=e,this.tree=new tt(n(n({componentName:this.engine.props.rootComponentName},this.engine.props.defaultComponentTree),{operation:this})),this.selection=new it({operation:this}),this.hover=new rt({operation:this}),this.outlineDragon=new lt({operation:this,sensitive:!1,forceBlock:!0,viewport:this.workspace.outline}),this.viewportDragon=new lt({operation:this,viewport:this.workspace.viewport}),this.selection.select(this.tree),this.makeObservable()}return e.prototype.dispatch=function(e,t){if(!1!==this.workspace.dispatch(e))return Designable.Shared.isFn(t)?t():void 0},e.prototype.getSelectedNodes=function(){var e=this;return this.selection.selected.map((function(t){return e.tree.findById(t)}))},e.prototype.setDragNodes=function(e){var t=e.reduce((function(e,t){var o;if(Designable.Shared.isFn(null===(o=null==t?void 0:t.designerProps)||void 0===o?void 0:o.getDragNodes)){var n=t.designerProps.getDragNodes(t);return n?e.concat(n):e}return"$$ResourceNode$$"===t.componentName?e.concat(t.children):e.concat([t])}),[]);this.outlineDragon.setDragNodes(t),this.viewportDragon.setDragNodes(t)},e.prototype.getDragNodes=function(){var e;return(null===(e=this.outlineDragon.dragNodes)||void 0===e?void 0:e.length)?this.outlineDragon.dragNodes:this.viewportDragon.dragNodes},e.prototype.getDropNodes=function(e){return this.getDragNodes().reduce((function(t,o){var n;if(Designable.Shared.isFn(null===(n=o.designerProps)||void 0===n?void 0:n.getDropNodes)){var i=o.isSourceNode?o.clone(o.parent):o,r=o.designerProps.getDropNodes(i,e);return r?t.concat(r):t}return"$$ResourceNode$$"===o.componentName?t.concat(o.children):t.concat([o])}),[])},e.prototype.getClosestNode=function(){return this.viewportDragon.closestNode||this.outlineDragon.closestNode},e.prototype.getClosestPosition=function(){return this.viewportDragon.closestDirection||this.outlineDragon.closestDirection},e.prototype.setTouchNode=function(e){this.outlineDragon.setTouchNode(e),this.viewportDragon.setTouchNode(e)},e.prototype.dragWith=function(e,t){var o=this.workspace.viewport;this.workspace.outline.isPointInViewport(e,!1)?(this.outlineDragon.calculate({point:e,touchNode:t||this.tree}),this.viewportDragon.calculate({touchNode:t||this.tree,closestNode:this.outlineDragon.closestNode,closestDirection:this.outlineDragon.closestDirection})):o.isPointInViewport(e,!1)?(this.viewportDragon.calculate({point:e,touchNode:t||this.tree}),this.outlineDragon.calculate({touchNode:t||this.tree,closestNode:this.viewportDragon.closestNode,closestDirection:this.viewportDragon.closestDirection})):this.setTouchNode(null)},e.prototype.dragClean=function(){this.outlineDragon.clear(),this.viewportDragon.clear()},e.prototype.getTouchNode=function(){return this.outlineDragon.touchNode||this.viewportDragon.touchNode},e.prototype.setDropNode=function(e){this.outlineDragon.setDropNode(e),this.viewportDragon.setDropNode(e)},e.prototype.getDropNode=function(){return this.outlineDragon.dropNode||this.viewportDragon.dropNode},e.prototype.removeNodes=function(e){for(var t=e.length-1;t>=0;t--){var o=e[t];if(o.allowDelete()){var n=o.previous,i=o.next;o.remove(),this.selection.select(n||(i||o.parent)),this.hover.clear()}}},e.prototype.sortNodes=function(e){return e.sort((function(e,t){return e.depth!==t.depth?0:e.index-t.index>=0?1:-1}))},e.prototype.cloneNodes=function(e){var t=this,o={},n={},i=this.sortNodes(e).filter((function(t){return!e.some((function(e){return t.isMyParents(e)}))}));Designable.Shared.each(i,(function(e){var t,i,r,s,a,l,c;e!==e.root&&e.allowClone()&&(o[null===(t=null==e?void 0:e.parent)||void 0===t?void 0:t.id]=o[null===(i=null==e?void 0:e.parent)||void 0===i?void 0:i.id]||[],o[null===(r=null==e?void 0:e.parent)||void 0===r?void 0:r.id].push(e),n[null===(s=null==e?void 0:e.parent)||void 0===s?void 0:s.id]?e.index>n[null===(a=null==e?void 0:e.parent)||void 0===a?void 0:a.id].index&&(n[null===(l=null==e?void 0:e.parent)||void 0===l?void 0:l.id]=e):n[null===(c=null==e?void 0:e.parent)||void 0===c?void 0:c.id]=e)}));var s=new Map;Designable.Shared.each(o,(function(e,o){var i=n[o];Designable.Shared.each(e,(function(e){var o=e.clone();if(o)if(t.selection.has(e)&&i.parent.allowAppend([o]))i.insertAfter(o),i=i.next;else if(1===t.selection.length){var n=t.tree.findById(t.selection.first),r=s.get(n);r||(r=[],s.set(n,r)),n&&n.allowAppend([o])&&r.push(o)}}))})),s.forEach((function(e,t){e.length&&t.append.apply(t,r(e))}))},e.prototype.makeObservable=function(){Formily.Reactive.define(this,{hover:Formily.Reactive.observable.ref,removeNodes:Formily.Reactive.action,cloneNodes:Formily.Reactive.action})},e.prototype.snapshot=function(e){var t=this;Designable.Shared.cancelIdle(this.requests.snapshot),this.workspace&&this.workspace.history&&!this.workspace.history.locking&&(this.requests.snapshot=Designable.Shared.requestIdle((function(){t.workspace.history.push(e)})))},e.prototype.from=function(e){e&&(e.tree&&this.tree.from(e.tree),e.selected&&(this.selection.selected=e.selected))},e.prototype.serialize=function(){return{tree:this.tree.serialize(),selected:[this.tree.id]}},e}(),ut=function(){function e(e,t){this.current=0,this.history=[],this.updateTimer=null,this.maxSize=100,this.locking=!1,this.context=e,this.props=t,this.push(),this.makeObservable()}return e.prototype.makeObservable=function(){Formily.Reactive.define(this,{current:Formily.Reactive.observable.ref,history:Formily.Reactive.observable.shallow,push:Formily.Reactive.action,undo:Formily.Reactive.action,redo:Formily.Reactive.action,goTo:Formily.Reactive.action,clear:Formily.Reactive.action})},e.prototype.list=function(){return this.history},e.prototype.push=function(e){var t;if(!this.locking){this.current<this.history.length-1&&(this.history=this.history.slice(0,this.current+1));var o={data:this.context.serialize(),timestamp:Date.now(),type:e};this.current=this.history.length,this.history.push(o);var n=this.history.length-this.maxSize;n>0&&(this.history.splice(0,n),this.current=this.history.length-1),(null===(t=this.props)||void 0===t?void 0:t.onPush)&&this.props.onPush(o)}},Object.defineProperty(e.prototype,"allowUndo",{get:function(){return this.history.length>0&&this.current-1>=0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"allowRedo",{get:function(){return this.history.length>this.current+1},enumerable:!1,configurable:!0}),e.prototype.redo=function(){var e;if(this.allowRedo){var t=this.history[this.current+1];this.locking=!0,this.context.from(t.data),this.locking=!1,this.current++,(null===(e=this.props)||void 0===e?void 0:e.onRedo)&&this.props.onRedo(t)}},e.prototype.undo=function(){var e;if(this.allowUndo){var t=this.history[this.current-1];this.locking=!0,this.context.from(t.data),this.locking=!1,this.current--,(null===(e=this.props)||void 0===e?void 0:e.onUndo)&&this.props.onUndo(t)}},e.prototype.goTo=function(e){var t,o=this.history[e];o&&(this.locking=!0,this.context.from(o.data),this.locking=!1,this.current=e,(null===(t=this.props)||void 0===t?void 0:t.onGoto)&&this.props.onGoto(o))},e.prototype.clear=function(){this.history=[],this.current=0},e}(),dt=function(){function e(e,t){var o=this;this.engine=e,this.props=t,this.id=t.id||Designable.Shared.uid(),this.title=t.title,this.description=t.description,this.viewport=new nt({engine:this.engine,workspace:this,viewportElement:t.viewportElement,contentWindow:t.contentWindow,nodeIdAttrName:this.engine.props.nodeIdAttrName}),this.outline=new nt({engine:this.engine,workspace:this,viewportElement:t.viewportElement,contentWindow:t.contentWindow,nodeIdAttrName:this.engine.props.outlineNodeIdAttrName}),this.operation=new ct(this),this.history=new ut(this,{onPush:function(e){o.operation.dispatch(new _(e))},onRedo:function(e){o.operation.hover.clear(),o.operation.dispatch(new V(e))},onUndo:function(e){o.operation.hover.clear(),o.operation.dispatch(new q(e))},onGoto:function(e){o.operation.hover.clear(),o.operation.dispatch(new U(e))}})}return e.prototype.getEventContext=function(){return{workbench:this.engine.workbench,workspace:this,engine:this.engine,viewport:this.viewport}},e.prototype.attachEvents=function(e,t){this.engine.attachEvents(e,t,this.getEventContext())},e.prototype.detachEvents=function(e){this.engine.detachEvents(e)},e.prototype.dispatch=function(e){return this.engine.dispatch(e,this.getEventContext())},e.prototype.serialize=function(){return{id:this.id,title:this.title,description:this.description,operation:this.operation.serialize()}},e.prototype.from=function(e){e&&(e.operation&&this.operation.from(e.operation),e.id&&(this.id=e.id),e.title&&(this.title=e.title),e.description&&(this.description=e.description))},e}(),ht=function(){function e(e){this.type="DESIGNABLE",this.engine=e,this.workspaces=[],this.currentWorkspace=null,this.activeWorkspace=null,this.makeObservable()}return e.prototype.makeObservable=function(){Formily.Reactive.define(this,{currentWorkspace:Formily.Reactive.observable.ref,workspaces:Formily.Reactive.observable.shallow,activeWorkspace:Formily.Reactive.observable.ref,type:Formily.Reactive.observable.ref,switchWorkspace:Formily.Reactive.action,addWorkspace:Formily.Reactive.action,removeWorkspace:Formily.Reactive.action,setActiveWorkspace:Formily.Reactive.action,setWorkbenchType:Formily.Reactive.action})},e.prototype.getEventContext=function(){return{engine:this.engine,workbench:this.engine.workbench,workspace:null,viewport:null}},e.prototype.switchWorkspace=function(e){var t=this.findWorkspaceById(e);return t&&(this.currentWorkspace=t,this.engine.dispatch(new Y(t))),this.currentWorkspace},e.prototype.setActiveWorkspace=function(e){return this.activeWorkspace=e,e},e.prototype.setWorkbenchType=function(e){this.type=e},e.prototype.addWorkspace=function(e){var t=this.findWorkspaceById(e.id);return t||(this.currentWorkspace=new dt(this.engine,e),this.workspaces.push(this.currentWorkspace),this.engine.dispatch(new L(this.currentWorkspace)),this.currentWorkspace)},e.prototype.removeWorkspace=function(e){var t=this.findWorkspaceIndexById(e);if(t>-1&&t<this.workspaces.length){var o=this.workspaces[t];o.viewport.detachEvents(),this.workspaces.splice(t,1),o===this.currentWorkspace&&(this.workspaces.length&&this.workspaces[t]?this.currentWorkspace=this.workspaces[t]:this.currentWorkspace=this.workspaces[this.workspaces.length-1]),this.engine.dispatch(new X(o))}},e.prototype.ensureWorkspace=function(e){void 0===e&&(e={});var t=this.findWorkspaceById(e.id);return t||(this.addWorkspace(e),this.currentWorkspace)},e.prototype.findWorkspaceById=function(e){return this.workspaces.find((function(t){return t.id===e}))},e.prototype.findWorkspaceIndexById=function(e){return this.workspaces.findIndex((function(t){return t.id===e}))},e.prototype.mapWorkspace=function(e){return this.workspaces.map(e)},e.prototype.eachWorkspace=function(e){this.workspaces.forEach(e)},e}();e.CursorStatus=void 0,(st=e.CursorStatus||(e.CursorStatus={})).Normal="NORMAL",st.DragStart="DRAG_START",st.Dragging="DRAGGING",st.DragStop="DRAG_STOP",e.CursorType=void 0,(at=e.CursorType||(e.CursorType={})).Move="MOVE",at.Selection="SELECTION";var pt={pageX:0,pageY:0,clientX:0,clientY:0,topPageX:0,topPageY:0,topClientX:0,topClientY:0},vt={scrollX:0,scrollY:0},ft=function(){function t(t){this.type=e.CursorType.Move,this.status=e.CursorStatus.Normal,this.position=pt,this.dragStartPosition=pt,this.dragStartScrollOffset=vt,this.dragEndPosition=pt,this.dragEndScrollOffset=vt,this.view=Designable.Shared.globalThisPolyfill,this.engine=t,this.makeObservable()}return t.prototype.makeObservable=function(){Formily.Reactive.define(this,{type:Formily.Reactive.observable.ref,status:Formily.Reactive.observable.ref,position:Formily.Reactive.observable.ref,dragStartPosition:Formily.Reactive.observable.ref,dragStartScrollOffset:Formily.Reactive.observable.ref,dragEndPosition:Formily.Reactive.observable.ref,dragEndScrollOffset:Formily.Reactive.observable.ref,view:Formily.Reactive.observable.ref,setStyle:Formily.Reactive.action,setPosition:Formily.Reactive.action,setStatus:Formily.Reactive.action,setType:Formily.Reactive.action})},t.prototype.setStatus=function(e){this.status=e},t.prototype.setType=function(e){this.type=e},t.prototype.setStyle=function(e){this.engine.workbench.eachWorkspace((function(t){!function(e,t){var o,n,i,r,s=null===(n=null===(o=null===document||void 0===document?void 0:document.getElementsByTagName)||void 0===o?void 0:o.call(document,"html"))||void 0===n?void 0:n[0],a=null===(r=null===(i=null==e?void 0:e.document)||void 0===i?void 0:i.getElementsByTagName("html"))||void 0===r?void 0:r[0];a&&a.style.cursor!==t&&(a.style.cursor=t),s&&s.style.cursor!==t&&(s.style.cursor=t)}(t.viewport.contentWindow,e)}))},t.prototype.setPosition=function(e){this.position=n(n({},this.position),e)},t.prototype.setDragStartPosition=function(e){this.dragStartPosition=n(n({},this.dragStartPosition),e)},t.prototype.setDragEndPosition=function(e){this.dragEndPosition=n(n({},this.dragEndPosition),e)},t.prototype.setDragStartScrollOffset=function(e){this.dragStartScrollOffset=n(n({},this.dragStartScrollOffset),e)},t.prototype.setDragEndScrollOffset=function(e){this.dragEndScrollOffset=n(n({},this.dragEndScrollOffset),e)},t}();const gt=Designable.Shared.KeyCode;var yt,bt,mt=function(){function e(e){this.codes=this.parseCodes(e.codes),this.handler=e.handler,this.matcher=e.matcher}return e.prototype.parseCodes=function(e){var t=[];return e.forEach((function(e){Array.isArray(e)?t.push(e):t.push([e])})),t},e.prototype.preventCodes=function(t){if(this.codes.length){for(var o=0;o<t.length;o++)for(var n=this.codes[o],i=0;i<n.length;i++)if(!e.matchCode(t[i],n[i]))return!1;return!0}return!1},e.prototype.matched=function(e,t){return Designable.Shared.isFn(this.handler)&&e&&this.handler(t),e},e.prototype.match=function(t,o){var n=this;return this.codes.some((function(i){var r=e.sortCodes(i),s=e.sortCodes(t);if(Designable.Shared.isFn(n.matcher))return n.matched(n.matcher(s),o);if(s.length!==r.length)return n.matched(!1,o);for(var a=0;a<r.length;a++)if(!e.matchCode(s[a],r[a]))return n.matched(!1,o);return n.matched(!0,o)}))},e.matchCode=function(e,t){var o,n;return(null===(o=null==e?void 0:e.toLocaleLowerCase)||void 0===o?void 0:o.call(e))===(null===(n=null==t?void 0:t.toLocaleLowerCase)||void 0===n?void 0:n.call(t))},e.sortCodes=function(e){return e.map((function(e){return e.toLocaleLowerCase()})).sort()},e}(),wt=[["metaKey",Designable.Shared.KeyCode.Meta],["shiftKey",Designable.Shared.KeyCode.Shift],["ctrlKey",Designable.Shared.KeyCode.Control],["altKey",Designable.Shared.KeyCode.Alt]],St=function(){function e(e){var t;this.shortcuts=[],this.sequence=[],this.keyDown=null,this.modifiers={},this.requestTimer=null,this.engine=e,this.shortcuts=(null===(t=e.props)||void 0===t?void 0:t.shortcuts)||[],this.makeObservable()}return e.prototype.matchCodes=function(e){for(var t=0;t<this.shortcuts.length;t++){if(this.shortcuts[t].match(this.sequence,e))return!0}return!1},e.prototype.preventCodes=function(){var e=this;return this.shortcuts.some((function(t){return t.preventCodes(e.sequence)}))},e.prototype.includes=function(e){return this.sequence.some((function(t){return mt.matchCode(t,e)}))},e.prototype.excludes=function(e){this.sequence=this.sequence.filter((function(t){return!mt.matchCode(e,t)}))},e.prototype.addKeyCode=function(e){this.includes(e)||this.sequence.push(e)},e.prototype.removeKeyCode=function(e){this.includes(e)&&this.excludes(e)},e.prototype.isModifier=function(e){return wt.some((function(t){return mt.matchCode(t[1],e)}))},e.prototype.handleModifiers=function(e){var t=this;wt.forEach((function(o){var n=i(o,2),r=n[0],s=n[1];e[r]&&(t.includes(s)||(t.sequence=[s].concat(t.sequence)))}))},e.prototype.handleKeyboard=function(e,t){"keydown"===e.eventType?(this.keyDown=e.data,this.addKeyCode(this.keyDown),this.handleModifiers(e),this.matchCodes(t)&&(this.sequence=[]),this.requestClean(),this.preventCodes()&&(e.preventDefault(),e.stopPropagation())):this.keyDown=null},e.prototype.isKeyDown=function(e){return this.keyDown===e},e.prototype.requestClean=function(){var e=this;clearTimeout(this.requestTimer),this.requestTimer=setTimeout((function(){e.keyDown=null,e.sequence=[],clearTimeout(e.requestTimer)}),4e3)},e.prototype.makeObservable=function(){Formily.Reactive.define(this,{sequence:Formily.Reactive.observable.shallow,keyDown:Formily.Reactive.observable.ref,handleKeyboard:Formily.Reactive.action})},e}();e.ScreenType=void 0,(yt=e.ScreenType||(e.ScreenType={})).PC="PC",yt.Responsive="Responsive",yt.Mobile="Mobile",yt.Sketch="Sketch",e.ScreenStatus=void 0,(bt=e.ScreenStatus||(e.ScreenStatus={})).Normal="Normal",bt.Resizing="Resizing",bt.Zooming="Zooming";var Dt=function(){function t(t){this.scale=1,this.width="100%",this.height="100%",this.background="",this.flip=!1,this.status=e.ScreenStatus.Normal,this.engine=t,this.type=t.props.defaultScreenType,this.makeObservable()}return t.prototype.makeObservable=function(){Formily.Reactive.define(this,{type:Formily.Reactive.observable.ref,scale:Formily.Reactive.observable.ref,width:Formily.Reactive.observable.ref,height:Formily.Reactive.observable.ref,status:Formily.Reactive.observable.ref,flip:Formily.Reactive.observable.ref,background:Formily.Reactive.observable.ref,setType:Formily.Reactive.action,setScale:Formily.Reactive.action,setSize:Formily.Reactive.action,resetSize:Formily.Reactive.action,setBackground:Formily.Reactive.action,setFlip:Formily.Reactive.action})},t.prototype.setStatus=function(e){this.status=e},t.prototype.setType=function(e){this.type=e},t.prototype.setScale=function(e){this.scale=e},t.prototype.setSize=function(e,t){e&&(this.width=e),t&&(this.height=t)},t.prototype.resetSize=function(){this.width="100%",this.height="100%"},t.prototype.setBackground=function(e){this.background=e},t.prototype.setFlip=function(e){this.flip=e},t}(),Et=function(t){function i(e){var o=t.call(this,e)||this;return o.props=n(n({},i.defaultProps),e),o.init(),o.id=Designable.Shared.uid(),o}return o(i,t),i.prototype.init=function(){this.workbench=new ht(this),this.screen=new Dt(this),this.cursor=new ft(this),this.keyboard=new St(this)},i.prototype.setCurrentTree=function(e){this.workbench.currentWorkspace&&this.workbench.currentWorkspace.operation.tree.from(e)},i.prototype.getCurrentTree=function(){var e,t,o;return null===(o=null===(t=null===(e=this.workbench)||void 0===e?void 0:e.currentWorkspace)||void 0===t?void 0:t.operation)||void 0===o?void 0:o.tree},i.prototype.getAllSelectedNodes=function(){for(var e=[],t=0;t<this.workbench.workspaces.length;t++){var o=this.workbench.workspaces[t];e=e.concat(o.operation.getSelectedNodes())}return e},i.prototype.findNodeById=function(e){return tt.findById(e)},i.prototype.findDraggingNodes=function(){var e=[];return this.workbench.eachWorkspace((function(t){var o;null===(o=t.operation.viewportDragon.dragNodes)||void 0===o||o.forEach((function(t){e.includes(t)||e.push(t)}))})),e},i.prototype.createNode=function(e,t){return new tt(e,t)},i.prototype.mount=function(){this.attachEvents(Designable.Shared.globalThisPolyfill)},i.prototype.unmount=function(){this.detachEvents()},i.defaultProps={shortcuts:[],effects:[],drivers:[],rootComponentName:"Root",sourceIdAttrName:"data-designer-source-id",nodeIdAttrName:"data-designer-node-id",contentEditableAttrName:"data-content-editable",contentEditableNodeIdAttrName:"data-content-editable-node-id",clickStopPropagationAttrName:"data-click-stop-propagation",nodeSelectionIdAttrName:"data-designer-node-helpers-id",nodeDragHandlerAttrName:"data-designer-node-handler",nodeResizeHandlerAttrName:"data-designer-node-resize-handler",outlineNodeIdAttrName:"data-designer-outline-node-id",nodeTranslateAttrName:"data-designer-node-translate-handler",defaultScreenType:e.ScreenType.PC},i}(Designable.Shared.Event);var Nt,Rt=new mt({codes:[[gt.Meta],[gt.Control]]}),Ct=new mt({codes:[gt.Shift]}),Pt=new mt({codes:[[gt.Meta,gt.X],[gt.Control,gt.X]]}),kt=new mt({codes:[[gt.Meta,gt.A],[gt.Control,gt.A]],handler:function(e){var t=null==e?void 0:e.workspace.operation;if(t){var o=t.tree;t.selection.batchSelect(o.descendants)}}}),At=new mt({codes:[[gt.Backspace],[gt.Delete]],handler:function(e){var t=null==e?void 0:e.workspace.operation;t&&t.removeNodes(t.getSelectedNodes())}}),Tt={nodes:[]},Ot=new mt({codes:[[gt.Meta,gt.C],[gt.Control,gt.C]],handler:function(e){var t=null==e?void 0:e.workspace.operation;t&&(Tt.nodes=t.getSelectedNodes())}}),It=new mt({codes:[[gt.Meta,gt.V],[gt.Control,gt.V]],handler:function(e){var t=null==e?void 0:e.workspace.operation;t&&t.cloneNodes(Tt.nodes)}}),Ft=new mt({codes:[[gt.Meta,gt.Z],[gt.Control,gt.Z]],handler:function(e){var t=null==e?void 0:e.workspace;t&&t.history.undo(),t.operation.hover.clear()}}),xt=new mt({codes:[[gt.Meta,gt.Shift,gt.Z],[gt.Control,gt.Shift,gt.Z]],handler:function(e){var t=null==e?void 0:e.workspace;t&&t.history.redo(),t.operation.hover.clear()}}),Mt=new mt({codes:[gt.Shift,gt.S],handler:function(t){var o=null==t?void 0:t.engine;o&&o.cursor.setType(e.CursorType.Selection)}}),Wt=function(e){return e&&e.lastChild?Wt(e.lastChild):e},Bt=function(e){var t;return e.parent?(null===(t=e.parent)||void 0===t?void 0:t.next)?e.parent.next:Bt(e.parent):e},Lt=new mt({codes:[[gt.Up],[gt.PageUp],[gt.ArrowUp],[gt.Left],[gt.LeftWindowKey],[gt.ArrowLeft]],handler:function(e){var t=null==e?void 0:e.workspace.operation;if(t){var o=t.tree,n=t.selection,i=o.findById(n.last);if(i){var r=i.previous;if(r){var s=Wt(r);s?n.select(s):n.select(r)}else n.select(i.parent)}}}}),Xt=new mt({codes:[[gt.Down],[gt.PageDown],[gt.ArrowDown],[gt.Right],[gt.RightWindowKey],[gt.ArrowRight]],handler:function(e){var t=null==e?void 0:e.workspace.operation;if(t){var o=t.tree,n=t.selection,i=o.findById(n.last);if(i){var r=i.firstChild?i.firstChild:i.next;r?n.select(r):n.select(Bt(i))}}}}),Yt=[function(t){t.subscribeTo(p,(function(o){t.cursor.setStatus(t.cursor.status===e.CursorStatus.Dragging||t.cursor.status===e.CursorStatus.DragStart?t.cursor.status:e.CursorStatus.Normal),t.cursor.setPosition(o.data)})),t.subscribeTo(c,(function(o){t.cursor.setStatus(e.CursorStatus.DragStart),t.cursor.setDragStartPosition(o.data)})),t.subscribeTo(l,(function(){t.cursor.setStatus(e.CursorStatus.Dragging)})),t.subscribeTo(u,(function(o){t.cursor.setStatus(e.CursorStatus.DragStop),t.cursor.setDragEndPosition(o.data),Designable.Shared.requestIdle((function(){t.cursor.setStatus(e.CursorStatus.Normal)}))})),t.subscribeTo(p,(function(o){var n,i,r=null===(n=null==o?void 0:o.context)||void 0===n?void 0:n.workspace;if(r){var s=r.operation;if(t.cursor.status===e.CursorStatus.Normal){var a=o.data.target,l=null===(i=null==a?void 0:a.closest)||void 0===i?void 0:i.call(a,"\n      *["+t.props.nodeIdAttrName+"],\n      *["+t.props.outlineNodeIdAttrName+"]\n    ");if(null==l?void 0:l.getAttribute){var c=l.getAttribute(t.props.nodeIdAttrName),u=l.getAttribute(t.props.outlineNodeIdAttrName),d=s.tree.findById(c||u);d?s.hover.setHover(d):s.hover.clear()}}else s.hover.clear()}}))},function(e){e.subscribeTo(M,(function(e){var t,o=null===(t=null==e?void 0:e.context)||void 0===t?void 0:t.workspace;if(o){var n=o.viewport,i=o.outline;n.matchViewport(e.data.target)&&n.digestViewport(),i.matchViewport(e.data.target)&&i.digestViewport()}})),e.subscribeTo(W,(function(e){var t,o=null===(t=null==e?void 0:e.context)||void 0===t?void 0:t.workspace;if(o){var n=o.viewport,i=o.outline;n.matchViewport(e.data.target)&&n.digestViewport(),i.matchViewport(e.data.target)&&i.digestViewport()}}))},function(t){t.subscribeTo(c,(function(o){if(t.cursor.type===e.CursorType.Move){var n=o.data.target,i=null==n?void 0:n.closest("\n       *["+t.props.nodeIdAttrName+"],\n       *["+t.props.sourceIdAttrName+"],\n       *["+t.props.outlineNodeIdAttrName+"]\n      "),r=null==n?void 0:n.closest("*["+t.props.nodeDragHandlerAttrName+"]"),s=null==r?void 0:r.closest("*["+t.props.nodeSelectionIdAttrName+"]");if((null==i?void 0:i.getAttribute)||r){var a=null==i?void 0:i.getAttribute(t.props.sourceIdAttrName),l=null==i?void 0:i.getAttribute(t.props.outlineNodeIdAttrName),c=null==s?void 0:s.getAttribute(t.props.nodeSelectionIdAttrName),u=null==i?void 0:i.getAttribute(t.props.nodeIdAttrName);t.workbench.eachWorkspace((function(e){var o=e.operation;if(u||l||c){var n=t.findNodeById(l||u||c);if(n){if(!n.allowDrag())return;if(n===n.root)return;var i=t.getAllSelectedNodes().filter((function(e){return e.allowDrag()}));i.some((function(e){return e===n}))?o.setDragNodes(o.sortNodes(i)):o.setDragNodes([n])}}else if(a){var r=t.findNodeById(a);if(r){if(!r.allowDrag())return;o.setDragNodes([r])}}})),t.cursor.setStyle("move")}}})),t.subscribeTo(l,(function(o){if(t.cursor.type===e.CursorType.Move){var n=o.data.target,i=null==n?void 0:n.closest("\n      *["+t.props.nodeIdAttrName+"],\n      *["+t.props.outlineNodeIdAttrName+"]\n    "),r=null==i?void 0:i.getAttribute(t.props.nodeIdAttrName),s=null==i?void 0:i.getAttribute(t.props.outlineNodeIdAttrName);t.workbench.eachWorkspace((function(e){var t=e.operation,n=t.tree,i=new Designable.Shared.Point(o.data.topClientX,o.data.topClientY);if(t.getDragNodes().length){var a=n.findById(s||r);t.dragWith(i,a)}}))}})),t.subscribeTo(W,(function(o){var n,i;if(t.cursor.type===e.CursorType.Move){var r=new Designable.Shared.Point(t.cursor.position.topClientX,t.cursor.position.topClientY),s=null===(n=null==o?void 0:o.context)||void 0===n?void 0:n.workspace;if(s){var a=s.operation;if(null===(i=a.getDragNodes())||void 0===i?void 0:i.length){var l=a.tree,c=s.viewport,u=s.outline,d=c.elementFromPoint(r),h=u.elementFromPoint(r),p=null==d?void 0:d.closest("\n      *["+t.props.nodeIdAttrName+"],\n      *["+t.props.outlineNodeIdAttrName+"]\n    "),v=null==h?void 0:h.closest("\n    *["+t.props.nodeIdAttrName+"],\n    *["+t.props.outlineNodeIdAttrName+"]\n  "),f=null==p?void 0:p.getAttribute(t.props.nodeIdAttrName),g=null==v?void 0:v.getAttribute(t.props.outlineNodeIdAttrName),y=l.findById(g||f);a.dragWith(r,y)}}}})),t.subscribeTo(u,(function(){t.cursor.type===e.CursorType.Move&&(t.workbench.eachWorkspace((function(t){var o=t.operation,n=o.getDragNodes(),i=o.getClosestNode(),s=o.getClosestPosition(),a=o.selection;n.length&&(n.length&&i&&s&&(s===e.ClosestPosition.After||s===e.ClosestPosition.Under?i.allowSibling(n)&&a.batchSafeSelect(i.insertAfter.apply(i,r(o.getDropNodes(i.parent)))):s===e.ClosestPosition.Before||s===e.ClosestPosition.Upper?i.allowSibling(n)&&a.batchSafeSelect(i.insertBefore.apply(i,r(o.getDropNodes(i.parent)))):s===e.ClosestPosition.Inner||s===e.ClosestPosition.InnerAfter?i.allowAppend(n)&&(a.batchSafeSelect(i.append.apply(i,r(o.getDropNodes(i)))),o.setDropNode(i)):s===e.ClosestPosition.InnerBefore&&i.allowAppend(n)&&(a.batchSafeSelect(i.prepend.apply(i,r(o.getDropNodes(i)))),o.setDropNode(i))),o.dragClean())})),t.cursor.setStyle(""))}))},function(t){var o={};t.subscribeTo(c,(function(i){if(t.cursor.type===e.CursorType.Move){var r=function(e){var o=null==e?void 0:e.closest("*["+t.props.nodeResizeHandlerAttrName+"]");if(o){var n=o.getAttribute(t.props.nodeResizeHandlerAttrName);if(n){var i=o.closest("*["+t.props.nodeSelectionIdAttrName+"]");if(i){var r=i.getAttribute(t.props.nodeSelectionIdAttrName);if(r){var s=t.findNodeById(r);if(s)return{axis:n.includes("x")?"x":"y",type:n,node:s,element:i}}}}}}(i.data.target);if(r){var s=new Designable.Shared.Point(i.data.clientX,i.data.clientY);o.value=n(n({},r),{point:s}),"x"===r.axis?t.cursor.setStyle("ew-resize"):"y"===r.axis&&t.cursor.setStyle("ns-resize")}}})),t.subscribeTo(l,(function(n){var i,r;if(t.cursor.type===e.CursorType.Move&&o.value){var s=o.value,a=s.axis,l=s.type,c=s.node,u=s.element,d=s.point,h=c.allowResize();if(!h)return;var p=c.designerProps.resizable,v=u.getBoundingClientRect(),f=new Designable.Shared.Point(n.data.clientX,n.data.clientY),g="x-end"===l?f.x>d.x:f.x<d.x,y="y-end"===l?f.y>d.y:f.y<d.y,b=h.includes("x"),m=h.includes("y"),w=null===(i=p.width)||void 0===i?void 0:i.call(p,c,u),S=null===(r=p.height)||void 0===r?void 0:r.call(p,c,u);if("x"===a){if(g&&"x-end"===l&&f.x<v.x+v.width)return;if(!g&&"x-end"===l&&f.x>v.x+v.width)return;if(g&&"x-start"===l&&f.x>v.x)return;if(!g&&"x-start"===l&&f.x<v.x)return;b&&(g?w.plus():w.minus())}else if("y"===a){if(y&&"y-end"===l&&f.y<v.y+v.height)return;if(!y&&"y-end"===l&&f.y>v.y+v.height)return;if(y&&"y-start"===l&&f.y>v.y)return;if(!y&&"y-start"===l&&f.y<v.y)return;m&&(y?S.plus():S.minus())}o.value.point=f}})),t.subscribeTo(u,(function(){t.cursor.type===e.CursorType.Move&&o.value&&(o.value=null,t.cursor.setStyle(""))}))},function(t){t.subscribeTo(d,(function(o){var n,i,r,s;if(t.cursor.status===e.CursorStatus.Normal){var a=o.data.target,l=null===(n=null==a?void 0:a.closest)||void 0===n?void 0:n.call(a,"\n      *["+t.props.nodeIdAttrName+"],\n      *["+t.props.outlineNodeIdAttrName+"]\n    "),c=null===(i=null==a?void 0:a.closest)||void 0===i?void 0:i.call(a,"*["+t.props.nodeSelectionIdAttrName+"]"),u=null!==(s=null===(r=o.context)||void 0===r?void 0:r.workspace)&&void 0!==s?s:t.workbench.activeWorkspace;if(u)if(null==l?void 0:l.getAttribute){var d=l.getAttribute(t.props.nodeIdAttrName),h=l.getAttribute(t.props.outlineNodeIdAttrName),p=u.operation,v=p.selection,f=p.tree,g=f.findById(d||h);g?(t.keyboard.requestClean(),t.keyboard.isKeyDown(Designable.Shared.KeyCode.Meta)||t.keyboard.isKeyDown(Designable.Shared.KeyCode.Control)?v.has(g)?v.selected.length>1&&v.remove(g):v.add(g):t.keyboard.isKeyDown(Designable.Shared.KeyCode.Shift)?v.has(g)?v.selected.length>1&&v.remove(g):v.crossAddTo(g):v.select(g)):v.select(f)}else{var y=new Designable.Shared.Point(o.data.topClientX,o.data.topClientY),b=u.operation,m=u.viewport,w=u.outline,S=m.isPointInViewport(y,!1),D=w.isPointInViewport(y,!1);if(c)return;if(S||D){var E=b.selection,N=b.tree;E.select(N)}}}}))},function(e){e.subscribeTo(f,(function(t){var o=e.keyboard;if(o){var n=e.workbench.activeWorkspace||e.workbench.currentWorkspace;o.handleKeyboard(t,n.getEventContext())}})),e.subscribeTo(g,(function(t){var o=e.keyboard;if(o){var n=e.workbench.activeWorkspace||e.workbench.currentWorkspace;o.handleKeyboard(t,n.getEventContext())}}))},function(t){var o=null,n=null,i=null,r=null,s=function(s,a){t.cursor.status===e.CursorStatus.Dragging&&(o=Designable.Shared.calcAutoScrollBasicInfo(s,"x",a.rect),n=Designable.Shared.calcAutoScrollBasicInfo(s,"y",a.rect),o?(i&&i(),i=Designable.Shared.scrollAnimate(a.scrollContainer,"x",o.direction,o.speed)):i&&i(),n?(r&&r(),r=Designable.Shared.scrollAnimate(a.scrollContainer,"y",n.direction,n.speed)):r&&r())};t.subscribeTo(c,(function(o){t.cursor.type!==e.CursorType.Move&&t.cursor.type!==e.CursorType.Selection||t.workbench.eachWorkspace((function(e){var n=e.viewport,i=e.outline,r=new Designable.Shared.Point(o.data.topClientX,o.data.topClientY);(n.isPointInViewport(r)||i.isPointInViewport(r))&&t.cursor.setDragStartScrollOffset({scrollX:n.scrollX,scrollY:n.scrollY})}))})),t.subscribeTo(l,(function(o){t.cursor.type!==e.CursorType.Move&&t.cursor.type!==e.CursorType.Selection||t.workbench.eachWorkspace((function(e){var t=e.viewport,n=e.outline,i=new Designable.Shared.Point(o.data.topClientX,o.data.topClientY);n.isPointInViewport(i)?s(i,n):t.isPointInViewport(i)&&s(i,t)}))})),t.subscribeTo(u,(function(){t.cursor.type!==e.CursorType.Move&&t.cursor.type!==e.CursorType.Selection||(o=null,n=null,i&&i(),r&&r())}))},function(e){e.subscribeWith(["append:node","insert:after","insert:before","insert:children","drag:node","drop:node","prepend:node","remove:node","select:node","update:children","wrap:node","update:node:props"],(function(t){var o;(null===(o=t.context)||void 0===o?void 0:o.workbench)&&e.workbench.setActiveWorkspace(t.context.workspace)})),e.subscribeTo(C,(function(t){e.workbench.eachWorkspace((function(e){e!==t.context.workspace&&e.operation.selection.clear()}))}))},function(t){t.subscribeTo(u,(function(o){t.cursor.type===e.CursorType.Selection&&(t.workbench.eachWorkspace((function(e){var o=e.viewport,n=new Designable.Shared.Point(t.cursor.dragStartPosition.topClientX,t.cursor.dragStartPosition.topClientY),r=o.getOffsetPoint(new Designable.Shared.Point(t.cursor.dragStartPosition.topClientX,t.cursor.dragStartPosition.topClientY)),s=o.getOffsetPoint(new Designable.Shared.Point(t.cursor.position.topClientX,t.cursor.position.topClientY));if(o.isPointInViewport(n,!1)){var a=e.operation.tree,l=Designable.Shared.calcRectByStartEndPoint(r,s,o.scrollX-t.cursor.dragStartScrollOffset.scrollX,o.scrollY-t.cursor.dragStartScrollOffset.scrollY),c=[];a.eachChildren((function(e){var t=o.getValidNodeOffsetRect(e);t&&Designable.Shared.isCrossRectInRect(l,t)&&c.push([e,t])}));var u=c.reduce((function(e,t){var o=i(t,2),n=o[0],r=o[1];return Designable.Shared.isRectInRect(r,l)&&c.some((function(e){return i(e,1)[0].isMyParents(n)}))?e:e.concat(n)}),[]);e.operation.selection.batchSafeSelect(u)}})),t.cursor.setType(e.CursorType.Move))}))},function(e){var t={activeElements:new Map,queue:[],requestTimer:null,isComposition:!1};function o(e){"Enter"===e.key&&(e.stopPropagation(),e.preventDefault())}function n(o){var n=this,i=t.activeElements.get(this);if(o.stopPropagation(),o.preventDefault(),i){var r=o.target,s=function(){if(t.queue.length=0,!t.isComposition){var o=function(e){var t=Designable.Shared.globalThisPolyfill.getSelection();if(!t.containsNode(e)){var o=function(e){for(var t=[],o=0;o<e.rangeCount;o++){var n=e.getRangeAt(o);t[o]={collapsed:n.collapsed,startOffset:n.startOffset,endOffset:n.endOffset}}return t}(t);return function(){var t=Designable.Shared.globalThisPolyfill.getSelection(),n=e.childNodes[0];n&&(t.removeAllRanges(),o.forEach((function(e){var o=document.createRange();o.collapse(e.collapsed),o.setStart(n,e.startOffset),o.setEnd(n,e.endOffset),t.addRange(o)})))}}}(r);Formily.Path.Path.setIn(i.props,n.getAttribute(e.props.contentEditableAttrName),null==r?void 0:r.textContent),Designable.Shared.requestIdle((function(){i.takeSnapshot("update:node:props"),o()}))}};t.queue.push(s),clearTimeout(t.requestTimer),t.requestTimer=setTimeout(s,600)}}function i(){clearTimeout(t.requestTimer),t.requestTimer=setTimeout(t.queue[t.queue.length-1],600)}function r(e){"compositionend"===e.type?(t.isComposition=!1,n(e)):(clearTimeout(t.requestTimer),t.isComposition=!0)}function s(e){e.preventDefault();var t=e.clipboardData.getData("text");this.textContent=t}e.subscribeTo(d,(function(o){var a,l=o.data.target,c=null===(a=null==l?void 0:l.closest)||void 0===a?void 0:a.call(l,"*["+e.props.contentEditableAttrName+"]");c&&"true"===c.getAttribute("contenteditable")||t.activeElements.forEach((function(e,o){t.activeElements.delete(o),o.removeAttribute("contenteditable"),o.removeAttribute("spellcheck"),o.removeEventListener("input",n),o.removeEventListener("compositionstart",r),o.removeEventListener("compositionupdate",r),o.removeEventListener("compositionend",r),o.removeEventListener("past",s),document.removeEventListener("selectionchange",i)}))})),e.subscribeTo(h,(function(a){var l,c=a.data.target,u=null===(l=null==c?void 0:c.closest)||void 0===l?void 0:l.call(c,"*["+e.props.contentEditableAttrName+"]"),d=e.workbench.activeWorkspace.operation.tree;if(u){var h=u.getAttribute("contenteditable");if("false"===h||!h){var p=function(t){if(t){var o=t.getAttribute(e.props.contentEditableNodeIdAttrName);if(o)return o;var n=t.closest("*["+e.props.nodeIdAttrName+"]");return n?n.getAttribute(e.props.nodeIdAttrName):void 0}}(u);if(p){var v=d.findById(p);v&&(t.activeElements.set(u,v),u.setAttribute("spellcheck","false"),u.setAttribute("contenteditable","true"),u.focus(),u.addEventListener("input",n),u.addEventListener("compositionstart",r),u.addEventListener("compositionupdate",r),u.addEventListener("compositionend",r),u.addEventListener("keydown",o),u.addEventListener("paste",s),document.addEventListener("selectionchange",i),function(e){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var o=Designable.Shared.globalThisPolyfill.getSelection();o.removeAllRanges(),o.addRange(t)}(u))}}}}))},function(t){var o={};t.subscribeTo(c,(function(i){if(t.cursor.type===e.CursorType.Move){var r=function(e){var o=null==e?void 0:e.closest("*["+t.props.nodeTranslateAttrName+"]");if(o&&o.getAttribute(t.props.nodeTranslateAttrName)){var n=o.closest("*["+t.props.nodeSelectionIdAttrName+"]");if(n){var i=n.getAttribute(t.props.nodeSelectionIdAttrName);if(i){var r=t.findNodeById(i);if(r)return{node:r,element:n}}}}}(i.data.target);if(r){var s=new Designable.Shared.Point(i.data.clientX,i.data.clientY);o.value=n(n({},r),{point:s})}}})),t.subscribeTo(l,(function(n){var i,r;if(t.cursor.type===e.CursorType.Move&&o.value){var s=o.value,a=s.node,l=s.element,c=s.point;if(!a.allowTranslate())return;var u=a.designerProps.translatable,d=new Designable.Shared.Point(n.data.clientX,n.data.clientY),h=d.x-(null==c?void 0:c.x),p=d.y-(null==c?void 0:c.y),v=null===(i=u.x)||void 0===i?void 0:i.call(u,a,l,h),f=null===(r=u.y)||void 0===r?void 0:r.call(u,a,l,p);v.translate(),f.translate(),o.value.point=d}})),t.subscribeTo(u,(function(){t.cursor.type===e.CursorType.Move&&o.value&&(o.value=null)}))}],zt=[K,H,G,Me,We,Xe],qt=[Pt,Rt,kt,Ct,At,Ot,It,Lt,Xt,Ft,xt,Mt],Vt=function(e){return(null==e?void 0:e.Behavior)&&Ut(e.Behavior)},Ut=function(e){return Array.isArray(e)&&e.every(_t)},_t=function(e){return(null==e?void 0:e.name)||(null==e?void 0:e.selector)||(null==e?void 0:e.extends)||(null==e?void 0:e.designerProps)||(null==e?void 0:e.designerLocales)},jt=function(e){return(null==e?void 0:e.Resource)&&Kt(e.Resource)},Kt=function(e){return Array.isArray(e)&&e.every(Ht)},Ht=function(e){return(null==e?void 0:e.node)&&!!e.node.isSourceNode&&e.node instanceof tt},Gt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o={};return e.forEach((function(e){ze(o,e)})),o},$t=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.reduce((function(e,t){if(Designable.Shared.isArr(t))return e.concat($t.apply(void 0,r(t)));var o=(t||{}).selector;return o?("string"==typeof o&&(t.selector=function(e){return e.componentName===o}),e.concat(t)):e}),[])},Zt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.reduce((function(e,t){return e.concat(n(n({},t),{node:new tt({componentName:"$$ResourceNode$$",isSourceNode:!0,children:t.elements||[]})}))}),[])},Jt=function(e){void 0===e&&(e={});var t=e.drivers||[],o=e.effects||[],i=e.shortcuts||[];return Formily.Reactive.untracked((function(){return new Et(n(n({},e),{effects:r(o,Yt),drivers:r(t,zt),shortcuts:r(i,qt)}))}))},Qt=Object.freeze({__proto__:null,isBehaviorHost:Vt,isBehaviorList:Ut,isBehavior:_t,isResourceHost:jt,isResourceList:Kt,isResource:Ht,createLocales:Gt,createBehavior:$t,createResource:Zt,createDesigner:Jt,GlobalRegistry:Ge,Engine:Et,get ScreenType(){return e.ScreenType},get ScreenStatus(){return e.ScreenStatus},Screen:Dt,get CursorStatus(){return e.CursorStatus},get CursorType(){return e.CursorType},Cursor:ft,Operation:ct,Viewport:nt,TreeNode:tt,Workbench:ht,Workspace:dt,Selection:it,get ClosestPosition(){return e.ClosestPosition},Dragon:lt,Keyboard:St,KeyCode:gt,Shortcut:mt,History:ut,DragMoveEvent:l,DragStartEvent:c,DragStopEvent:u,MouseClickEvent:d,MouseDoubleClickEvent:h,MouseMoveEvent:p,KeyDownEvent:f,KeyUpEvent:g,DragNodeEvent:b,DropNodeEvent:m,HoverNodeEvent:w,InsertAfterEvent:S,InsertBeforeEvent:D,InsertChildrenEvent:E,PrependNodeEvent:N,RemoveNodeEvent:R,SelectNodeEvent:C,UnSelectNodeEvent:P,UpdateChildrenEvent:k,UpdateNodePropsEvent:A,WrapNodeEvent:T,CloneNodeEvent:O,AppendNodeEvent:I,FromNodeEvent:F,ViewportResizeEvent:M,ViewportScrollEvent:W,AddWorkspaceEvent:L,RemoveWorkspaceEvent:X,SwitchWorkspaceEvent:Y,HistoryUndoEvent:q,HistoryRedoEvent:V,HistoryGotoEvent:U,HistoryPushEvent:_});(null===(Nt=null===Designable.Shared.globalThisPolyfill||void 0===Designable.Shared.globalThisPolyfill?void 0:Designable.Shared.globalThisPolyfill.Designable)||void 0===Nt?void 0:Nt.Core)?module&&module.exports&&(module.exports=n({__esModule:!0},Designable.Shared.globalThisPolyfill.Designable.Core)):(Designable.Shared.globalThisPolyfill.Designable=Designable.Shared.globalThisPolyfill.Designable||{},Designable.Shared.globalThisPolyfill.Designable.Core=Qt),e.AddWorkspaceEvent=L,e.AppendNodeEvent=I,e.CloneNodeEvent=O,e.Cursor=ft,e.DragMoveEvent=l,e.DragNodeEvent=b,e.DragStartEvent=c,e.DragStopEvent=u,e.Dragon=lt,e.DropNodeEvent=m,e.Engine=Et,e.FromNodeEvent=F,e.GlobalRegistry=Ge,e.History=ut,e.HistoryGotoEvent=U,e.HistoryPushEvent=_,e.HistoryRedoEvent=V,e.HistoryUndoEvent=q,e.HoverNodeEvent=w,e.InsertAfterEvent=S,e.InsertBeforeEvent=D,e.InsertChildrenEvent=E,e.KeyCode=gt,e.KeyDownEvent=f,e.KeyUpEvent=g,e.Keyboard=St,e.MouseClickEvent=d,e.MouseDoubleClickEvent=h,e.MouseMoveEvent=p,e.Operation=ct,e.PrependNodeEvent=N,e.RemoveNodeEvent=R,e.RemoveWorkspaceEvent=X,e.Screen=Dt,e.SelectNodeEvent=C,e.Selection=it,e.Shortcut=mt,e.SwitchWorkspaceEvent=Y,e.TreeNode=tt,e.UnSelectNodeEvent=P,e.UpdateChildrenEvent=k,e.UpdateNodePropsEvent=A,e.Viewport=nt,e.ViewportResizeEvent=M,e.ViewportScrollEvent=W,e.Workbench=ht,e.Workspace=dt,e.WrapNodeEvent=T,e.createBehavior=$t,e.createDesigner=Jt,e.createLocales=Gt,e.createResource=Zt,e.isBehavior=_t,e.isBehaviorHost=Vt,e.isBehaviorList=Ut,e.isResource=Ht,e.isResourceHost=jt,e.isResourceList=Kt,Object.defineProperty(e,"__esModule",{value:!0})}));
